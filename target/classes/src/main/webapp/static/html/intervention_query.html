<div role="tabpanel" ng-class="{true: 'tab-pane fade active in', false: 'tab-pane fade'}[tab.pattern_inner_isActive]" id="intervention-query" aria-labelledby="intervention-query-tab">
    <br>
    <!--<div class="row" style="float: right;margin-right: 20%;" id="query_intervention_page_right">
        <div class="col-sm-offset-2 col-sm-3">
            <a class="btn btn-info" href="/all/index?appid={{appid}}">返回应用全景</a>
        </div>
    </div>-->
    <div class="row" id="query_intervention_page_top">
        <form class="form-horizontal col-md-8 nlu-margin-top27" role="form" id="query_form">
            <div style="display:none">
                <select id="default_slot_list">
                    <option ng-repeat="sl in query.slot_list" value="{{sl.slot_name}}">{{sl.slot_name}}</option>
                </select>
            </div>
            <button disabled="" id="zhedie_button" style="float: none;" class="btn btn-default btn-xs " data-toggle="collapse" data-target="#demo">
                高级选项（待开放）
            </button>
            <br>
            <br>
            <div id="demo" class="collapse">
                <div class="form-group">
                    <label for="last_intent" class="col-sm-2 control-label">上轮意图</label>
                    <div class="col-sm-8">
                        <select class="form-control" id="pre_intent">
                            <option value="None">None</option>
                            <option value="{{il.intent_name}}" ng-repeat="il in query.intent_list">
                                {{il.intent_name}}<span ng-show="il.description.length>0">({{il.description}})</span>
                            </option>
                        </select>
                    </div>
                </div>
                <!--<div class="form-group">
            <label for="last_need" class="col-sm-2 control-label">上轮需求</label>
            <div class="col-sm-8">
                <select class="form-control" id="pre_func_slot">
                    <option value="None">None</option>
                    <option value="info-ynq">用户主动单轮-信息查询类-是非问(info-ynq)</option>
                    <option value="info-slctq">用户主动单轮-信息查询类-比较/选项问(info-slctq)</option>
                    <option value="info">用户主动单轮-信息查询类-其他查询问(info)</option>
                    <option value="exe">用户主动单轮-请求行为类(exe)</option>
                    <option value="update">用户主动多轮-信息更新类(update)</option>
                    <option value="ans-info">BOT主动多轮-用户答复类-提供信息(ans-info)</option>
                    <option value="ans-yn">BOT主动多轮-用户答复类-是非答复(ans-yn)</option>
                </select>
            </div>
        </div>-->
                <div class="form-group">
                    <label for="last_action" class="col-sm-2 control-label">上轮动作</label>
                    <div class="col-sm-8">
                        <select class="form-control" id="pre_action">
                            <option value="None">None</option>
                            <option value="{{an.action_name}}" ng-repeat="an in query.action_list">{{an.action_name}}</option>
                        </select>
                    </div>
                </div>
                <hr>
            </div>
            <div class="form-group">
                <label for="query" class="col-sm-2 control-label">实例</label>
                <input type="hidden" id="query_id" value="">
                <input type="hidden" id="next_id" value="">
                <input type="hidden" id="now_query" value="">
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="wait_intervene" placeholder="" onblur="do_wordseg();" tabIndex="400">
                </div>
                <div class="col-sm-2">
                    <button class="btn btn-default btn-block" id="query_clear_all" onclick="query_all();">清空</button>
                </div>
            </div>
            <div class="form-group">
                <label for="intent" class="col-sm-2 control-label">意图</label>
                <div class="col-sm-8">
                    <select id="editable-select-add-intent-no-func-slot" class="form-control" placeholder="选择或者输入一个意图"  tabIndex="500"><!--onchange="set_slots_twice()"-->
                        <option value="">请选择</option>
                        <option value="{{il.intent_name}}" ng-repeat="il in query.intent_list">{{il.intent_name}}<span ng-if="!il.description.length>0">({{il.description}})</span></option>
                    </select>
                </div>
            </div>
            <!--<div class="form-group">
            <label for="intent" class="col-sm-2 control-label" >当前需求</label>
            <div class="col-sm-8">
                <select class="form-control" id="now_func_slot" required="true" value="info" onchange="slot_recommend();">
                    <option value="info-ynq">用户主动单轮-信息查询类-是非问(info-ynq)</option>
                    <option value="info-slctq">用户主动单轮-信息查询类-比较/选项问(info-slctq)</option>
                    <option value="info">用户主动单轮-信息查询类-其他查询问(info)</option>
                    <option value="exe">用户主动单轮-请求行为类(exe)</option>
                    <option value="update">用户主动多轮-信息更新类(update)</option>
                    <option value="ans-info">BOT主动多轮-用户答复类-提供信息(ans-info)</option>
                    <option value="ans-yn">BOT主动多轮-用户答复类-是非答复(ans-yn)</option>
                    <option value="null">请选择</option>
                </select>
            </div>
        </div> -->
            <div class="form-group" ng-show="slot_list.length !=0">
                <label for="query" class="col-sm-2 control-label">分词</label>
                <input type="hidden" value="yes" id="word_seg_res_check_flag">
                <div class="col-sm-8" id="word_seg_res_btn_list">
                    <!--//tabIndex="600"  分词结果的tabindex从600开始加-->
                </div>
            </div>
            <div class="form-group" id="btn_check_ok_div" style="display:none">
                <label for="query" class="col-sm-2 control-label"></label>
                <div class="col-sm-8">
                    <button class="btn btn-success" id="btn_check_ok" onclick="click_check_ok_btn()">确认( Alt+/ )</button>
                </div>
            </div>
            <div class="form-group">
                <label for="intent" class="col-sm-2 control-label">槽位</label>
                <div class="col-sm-10">
                    <table class="table table-bordered query-slot-table" id="slot_table">
                        <!--//tabIndex="1000"  分词结果的tabindex从600开始加-->
                        <thead>
                            <tr>
                                <th>取词</th>
                                <th>槽位类型</th>
                                <!--<th>承担角色</th>-->
                                <th>编辑</th>
                            </tr>
                        </thead>
                        <tbody id="slot_tbody">
                            <tr class="query-slot-tr copyTr" id="copyTr" style="display:none;">
                                <td>
                                    <input name="slotMerge" type="checkbox" style="width: 10%;float: left;display:none">
                                    <input class="" name="word" value="" title="单击编辑" placeholder="请单击输入内容" readonly="true" style="border:none" btn_id_list="" word_start_length_list="">
                                    <!--style="margin-left: 5%;width: 85%;"-->
                                </td>
                                <td>
                                    <select id="slotSelect" name="type" placeholder="输入模糊匹配">
                                        <option value=""></option>
                                        <option value="{{sl.slot_name}}" ng-repeat="sl in query.slot_list">{{sl.slot_name}}</option>
                                    </select>
                                </td>
                                <!--<td>
                                <input class="" name="role" value="" title="单击编辑" placeholder="请单击输入内容">
                            </td>-->
                                <td>
                                    <button type="button" class="btn btn-danger btn-xs" data-action="quSlotDele" onclick="qu_slot_delete(this)">
                                        <span class="glyphicon glyphicon-trash"></span>删除
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="form-group">
                <!--<div class="col-sm-offset-2 col-sm-2">
                    <button class="btn btn-default " id="slotMerge" onclick="merge_slot_word();">合并取词</button>
                </div>
                <div class="col-sm-offset-0 col-sm-2">
                    <button class="btn btn-default " id="slotMerge" onclick="cancel_merge();">重新标注</button>
                </div>
                <div class="col-sm-offset-2 col-sm-2">
                    <button class="btn btn-default " id="intertBtn">新增槽位</button>
                </div>
                <div class="col-sm-offset-10 col-sm-2">
                    <a class="btn btn-nlu " id="btn_query_intervention_page_save" ng-click="save_query();" tabIndex="2000">保存</a>
                </div>-->
            </div>
            <div class="form-group" >
                <div class="col-sm-offset-2 col-sm-3">
                    <a class="btn btn-info btn-block" href="/all/index?appid={{appid}}">返回应用全景</a>
                </div>
                <div class="col-sm-2">
                    <a class="btn btn-nlu " id="btn_query_intervention_page_save" ng-click="save_query();" tabIndex="2000">保存(Enter)</a>
                </div>
                <!--<div class="col-sm-2">
                <button class="btn btn-nlu-blue btn-block" ng-click="intervene_effect();">生效</button>
            </div>-->
            </div>
        </form>
        <div class="col-md-4 nlu-margin-topm47" style="margin-top:-18px;">
        <div class="nlu-right" style="width: 105.7%;">
            <div class="row nlu-label" style="padding-top: 23px; padding-left: 5%;">
                <div class="query_select_package_div" style="float: left;margin-bottom:26px;margin-left: 3%;">
                    <button id="query_select_package" data-toggle="modal" href="#myModalChoosePackage" class="btn btn-primary">{{now_package_name | limitTo:15}}<span ng-if="now_package_name.length>15">...</span></button>
                    <!-- Modal -->
                    <div class="modal fade in" id="myModalChoosePackage" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" >
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                            <h4 class="modal-title" id="myModalLabel">请选择要展现的包</h4>
                          </div>
                          <div class="modal-body">
                            <ul style="margin-left: 4%;overflow:auto;height:500px;" id="ztree" class="ztree">
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-info" data-dismiss="modal" id="query_tree_check_btn">确定</button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- end modal -->
                    <!--<select id="query_select_package" name="type" class="form-control" ng-change="choose_pacakge('query')" ng-model="cpk">
                        <option value="" ng-if="!package_list.query_package.length">请选择</option>
                        <option value="{{qp.id}}" ng-repeat=" qp in package_list.query_package">{{qp.name}}</option>
                    </select>-->
                </div>
                <a class="btn btn-default" data-toggle="modal" data-target="#import_wait_intervention" style="margin-left: 2%;">导入</a>
                <label style="margin-left: 2%;width: 100px;"><input type="checkbox" id="check_qlist" style="margin-left:3%" ng-click="changeqliststatus()"> querylist启用</label>
                <!--<a  class="btn btn-default" data-toggle="modal"  data-target="#import_query_div" style="float: right;margin-right: 15%;">导入</a>-->
                <!-- import Modal -->
                <div class="modal fade" id="import_query_div" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                <h4 class="modal-title" id="myModalLabel">导入<a href = "/intervene/querysample">(实例样本)</a><!--<a href = "/intervene/patternsample">(模板样本)</a>--></h4>
                            </div>

                            <div class="modal-body">
                                <br>
                                <form class="form-horizontal" role="form" id="form_import">
                       <!--          <div class="form-group">
                                         <label for="query"  class="col-sm-2 control-label">样本文件</label>
                                        <div class="col-sm-10">
                                           <a href = "/intervene/patternsample">点击下载</a>
                                        </div>
                                    </div> -->
                                    <div class="form-group">
                                         <label for="query"  class="col-sm-2 control-label">创建包名称</label>
                                        <div class="col-sm-10">
                                            <input type="text" class="form-control" ng-model="query_package_name">
                                    </div>
                                    </div>
                                    <div class="form-group">
                                      <label for="query"  class="col-sm-2 control-label">类型</label>
                                      <div class="col-sm-10">
                                      <select  class="form-control" id = "import_type_select" ng-model = "model_import_type_select">
                                        <option value="query" selected="true">训练集</option>
                                        <!--<option value="pattern">模板</option>-->
                                        <option value="eval_query">评估集</option>
                                      </select>
                                      </div>
                                    </div>

                                    <div class="form-group" ng-if="model_import_type_select=='query'">
                                         <label for="query"  class="col-sm-2 control-label">数据导入</label>
                                        <div class="col-sm-10">

                                        <input type="radio" ng-model="import.import_type" name="radio_import_type" value="all">全部作为训练集
                                        <input type="radio" ng-model="import.import_type"  name="radio_import_type" value="part">部分作为评估数据集
                                        </div>
                                    </div>

                                    <div class="form-group" ng-if="model_import_type_select == 'query' && import.import_type=='part'">
                                         <label for="query"  class="col-sm-2 control-label" >作为评估的数据量</label>
                                        <div class="col-sm-10">
                                            <input type="text" class="form-control" id="input_query_num" ng-model="import.num" placeholder="只能输入数字" onkeypress='return event.charCode >= 48 && event.charCode <= 57'>

                                        </div>
                                    </div>

                        <!--             <div class="form-group" ng-if="import.import_type=='part' && model_import_type_select == 'query'">
                                         <label for="query"  class="col-sm-2 control-label">评估包创建</label>
                                        <div class="col-sm-10">

                                        <input type="radio" ng-model="import.to_type" name="radio_to_type" value="new">创建新的评估包
                                        <input type="radio" ng-model="import.to_type"  name="radio_to_type" value="exist">导入现有评估包
                                        </div>
                                    </div> -->


                         <!--           <div class="form-group" ng-if ="import.to_type == 'exist'">
                                         <label for="query"  class="col-sm-2 control-label">选择评估包名</label>
                                        <div class="col-sm-10" >
                                           <input type="text" class="form-control" ng-model="query_package_name">
                                            <select ng-model="import.to_package" class="form-control">
                                              <option>package1</option>
                                              <option>package2</option>
                                              <option>package3</option>
                                            </select>
                                        </div>
                                    </div>  -->

                                    <div class="form-group">
                                         <label for="query"  class="col-sm-2 control-label">文件位置</label>
                                        <div class="col-sm-10">
                                            <input type="file" class="form-control" name="file_name_test" id="intput_import_query">
                                        </div>
                                    </div>
                                </form>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" ng-click="upload_file('0', model_import_type_select,import.import_type, import.num, query_package_name)">导入</button>
                                    <button type="button" class="btn btn-default" data-dismiss="modal" id="cancel_import">取消</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end modal -->


                <!--<a class="btn btn-default btn-sm" data-toggle="modal" data-target="#import_already_intervention">导入已标注集</a> -->
                <!-- copy Modal -->

                <div class="modal fade" id="import_wait_intervention" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                <h4 class="modal-title" id="myModalLabel">导入待标注集<a href = "unquerysample">(示例文件)</a></h4>
                            </div>
                            <div class="modal-body">
                                <br>
                                <form class="form-horizontal" role="form" id="form_import_wait_intervention">
                                    <div class="form-group">
                                        <label for="package_name" class="col-sm-2 control-label">导入的包名</label>
                                        <div class="col-sm-10">
                                            <input id="package_name" class="form-control" value="" required="true">
                                        </div>
                                    </div>
                                    <!--        <div class="form-group">
                                         <label for="query"  class="col-sm-2 control-label">样本文件</label>
                                        <div class="col-sm-10">
                                           <a href = "unquerysample">点击下载</a>
                                        </div>
                                    </div> -->
                                    <!--   <div class="form-group">
                                         <label for="query"  class="col-sm-2 control-label">上传文件</label> -->
                                    <div>
                                        <input type="file" class="form-control" name="file_name_test" id="intput_import_wait_intervention">
                                    </div>
                                    <!--   </div> -->
                                </form>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" ng-click="upload_file('import_wait_intervention')">导入</button>
                                    <button type="button" class="btn btn-default" data-dismiss="modal" id="cancel_import_wait_intervention">取消</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="import_already_intervention" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                <h4 class="modal-title" id="myModalLabel">导入已标注集 <a href = "querysample">(示例文件)</a></h4>
                            </div>
                            <div class="modal-body">
                                <br>
                                <form class="form-horizontal" role="form" id="form_import_already_intervention">
                                    <!--         <div class="form-group">
                                         <label for="query"  class="col-sm-2 control-label">样本文件</label>
                                        <div class="col-sm-10">
                                           <a href = "querysample">点击下载</a>
                                        </div>
                                    </div> -->
                                    <!--          <div class="form-group">
                                         <label for="query"  class="col-sm-2 control-label">上传文件</label> -->
                                    <div>
                                        <input type="file" class="form-control" id="intput_import_already_intervention" name="file_name_test">
                                    </div>
                                    <!--    </div> -->
                                </form>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" ng-click="upload_file('import_already_intervention')">导入</button>
                                    <button type="button" class="btn btn-default" data-dismiss="modal" id="cancel_import_already_intervention">取消</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--    <a class="btn btn-default btn-sm" href="/intervene/export?appid={{appid}}&status=0">导出已标注集</a> -->
                <!--  <span class="glyphicon glyphicon-export nlu-label-export-icon" > -->
                <!--      <a class="glyphicon glyphicon-export nlu-label-export-icon" href="/intervene/export?appid={{appid}}&status=0"></a> -->
                <hr class="nlu-label-hr" style="margin-left:1%;display:none" >
                <div class="row">
                    <div class="form-group col-md-12">
                        <!--<label class="nlu-wait-label col-sm-5">实例<span class="badge badge-warning">{{query_wait_intervene.total}}</span></label>-->
                        <div class="input-group input-group-sm nlu-search col-sm-8" style="width: 52%;margin-left: 4%;">
                            <input type="text" class="form-control" placeholder="请输入关键字搜索" id="search_intervention" ng-model="search_query_intervention" value="">
                            <span class="input-group-btn">
                             <button class="btn btn-default btn-sm" type="button" ng-click="get_query_list(now_package_id, 'wait', 1, '5', search_query_intervention)"><span class="glyphicon glyphicon-search" ></span></button>
                            </span>
                        </div>
                        <label class="col-sm-4" style="margin-top: -24px;float: right;">{{now_package.labeled_count}} / {{now_package.current_volume}}</label>
                        <!-- /input-group -->
                    </div>
                    <!-- /form-group -->
                </div>
                <!-- /row -->
                <!-- <hr class="nlu-label-hr-light"> -->
                <div class="row">
                    <div class="nlu-label-table">
                        <table class="table table-condensed col-md-8">
                            <thead>
                                <th class="sorting" ng-click="show_order('order_query', 'query', search_query_intervention)" id="order_query">实例</th>
                                <th class="sorting" ng-click="show_order('order_intent', 'intent', search_query_intervention)" id="order_intent">意图</th>
                                <th class="sorting" ng-click="show_order('order_status', 'status', search_query_intervention)" id="order_status">状态</th>
                                <th></th>
                            </thead>
                            <tbody>
                                <tr ng-repeat="wi in query_wait_intervene.query_list">
                                    <td style="text-align:left" title="{{wi.query}}"><a href="" ng-click="query_edit_func(wi.id, '2')">{{wi.query | limitTo:10}}<span ng-if="wi.query.length>10">...</span></a></td>
                                    <td>{{wi.intent}}</td>
                                    <td ng-if="wi.status==0 ">已验证</td>
                                    <td ng-if="wi.status==2 ">未验证</td>
                                    <td><span class="glyphicon glyphicon-trash" ng-click="del_query(query_wait_intervene.package_id, wi.id, 'wait', query_wait_intervene.this_page, '2')"></span></td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="nlu-label-page">
                            <div class="btn-group">
                                <button class="btn btn-default  btn-xs" ng-click="get_labeldata_list(now_package_type, now_package_id, 1, '5', search_query_intervention);"><i class="glyphicon glyphicon-step-backward"></i></button>
                                <button class="btn btn-default  btn-xs" ng-click="get_labeldata_list(now_package_type, now_package_id, query_wait_intervene.pre_page, '5', search_query_intervention);"><i class="glyphicon glyphicon-chevron-left"></i> </button>
                                <button class="btn btn-primary btn-xs">{{query_wait_intervene.this_page}}</button>
                                <button class="btn btn-default btn-xs" ng-click="get_labeldata_list(now_package_type, now_package_id, query_wait_intervene.next_page, '5', search_query_intervention);"><i class="glyphicon glyphicon-chevron-right"></i></button>
                                <button class="btn btn-default btn-xs" ng-click="get_labeldata_list(now_package_type, now_package_id, query_wait_intervene.pageall, '5', search_query_intervention);"><i class="glyphicon glyphicon-step-forward"></i></button>
                                <button class="btn btn-default btn-xs disabled">({{query_wait_intervene.pageall}}页)</button>
                                <div class="input-group input-group-xs">
                                    <input type="text" class="form-control" id="query_wait_intervene_goto_page" value="{{goto_some_page_intervention}}" placeholder="跳转页" ng-model="goto_some_page_intervention" style="height: 22px;font-size: 12px;">
                                    <span class="input-group-btn">
                                        <button class="btn btn-default  btn-xs" type="button" ng-click="get_labeldata_list(now_package_type, now_package_id, goto_some_page_intervention, '5', search_query_intervention);" ><span class="glyphicon glyphicon-arrow-right" ></span></button>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <hr class="nlu-label-hr-table">
                    </div>
                    <!-- /nlu-label-table -->
                </div>
                <!-- /row -->
                <div class="row" style="display:none">
                    <div class="form-group">
                        <label class="nlu-wait-label col-sm-5">已标注<span class="badge badge-warning">{{query_intervened.total}}</span></label>
                        <div class="input-group input-group-sm nlu-search">
                            <input type="text" class="form-control" placeholder="请输入关键字搜索" id="search_intervened" ng-model="search_query_intervened" value="">
                            <span class="input-group-btn">
                                   <button class="btn btn-default btn-xs" type="button" ng-click="get_query_list('done', 1, '0', search_query_intervened)"><span class="glyphicon glyphicon-search" ></span></button>
                            </span>
                        </div>
                        <!-- /input-group -->
                    </div>
                    <!-- /form-group -->
                </div>
                <!-- /row -->
                <!-- <hr class="nlu-label-hr-light"> -->
                <div class="row" style="display:none">
                    <div class="nlu-label-table">
                        <table class="table table-condensed col-md-8">
                            <tbody>
                                <tr ng-repeat="wi in query_intervened.query_list">
                                    <td style="text-align:left" title="{{wi.query}}"><a href="" ng-click="query_edit_func(wi.id, '0')">{{wi.query | limitTo:10}}<span ng-if="wi.query.length>10">...</span></a></td>
                                    <td>{{wi.update_time}}</td>
                                    <td><span class="glyphicon glyphicon-trash" ng-click="del_query(wi.id, 'done', query_intervened.this_page, '0')"></span></td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="nlu-label-page">
                            <div class="btn-group">
                                <button class="btn btn-default btn-xs" ng-click="get_query_list('done', 1, '0', search_query_intervened);"><i class="glyphicon glyphicon-step-backward"></i></button>
                                <button class="btn btn-default btn-xs" ng-click="get_query_list('done', query_intervened.pre_page, '0', search_query_intervened);"><i class="glyphicon glyphicon-chevron-left"></i></button>
                                <button class="btn btn-primary btn-xs">{{query_intervened.this_page}}</button>
                                <button class="btn btn-default btn-xs" ng-click="get_query_list('done', query_intervened.next_page, '0', search_query_intervened);"><i class="glyphicon glyphicon-chevron-right"></i></button>
                                <button class="btn btn-default btn-xs" ng-click="get_query_list('done', query_intervened.pageall, '0', search_query_intervened);"><i class="glyphicon glyphicon-step-forward"></i></button>
                                <button class="btn btn-default btn-xs disabled">({{query_intervened.pageall}}页)</button>
                                <div class="input-group input-group-md">
                                    <input type="text" class="form-control" id="query_intervened_goto_page" value="{{goto_some_page_intervened}}" placeholder="跳转页" ng-model="goto_some_page_intervened" style="height: 22px;font-size: 12px;">
                                    <span class="input-group-btn input-troup-btn-xs">
                                        <button class="btn btn-default  btn-xs" type="button" ng-click="get_query_list('done', goto_some_page_intervened, '0', search_query_intervened);" ><span class="glyphicon glyphicon-arrow-right" ></span></button>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /nlu-label-table -->
                </div>
                <!-- /row -->
                <br>
                <hr class="nlu-label-hr-light" style="display:none">
                <br>
                <br>
            </div>
            <!-- /nlu-right -->
        </div>
        <!-- end middle -->
    </div>

    </div>
    <!-- end row -->
    <div class="row" id="query_intervention_page_bottom">
        <!-- <div class="col-md-3">
            <ul style="margin-left: 4%;overflow:auto;height:500px;" id="ztree" class="ztree">
        </div>-->
        <div class="col-md-12">
            <hr>
            <table class="table table-condensed table-bordered table-hover">
                <thead>
                    <th>实例</th>
                    <th>标注意图</th>
                    <th ng-if="now_package_type == 'eval_query' ">自动标注意图</th>
                    <th ng-if="now_package_type == 'eval_query' ">匹配</th>
                    <th>槽位</th>
                    <th ng-if="now_package_type == 'eval_query' ">自动标注槽位</th>
                    <th ng-if="now_package_type == 'eval_query' ">槽位匹配</th>
                    <th>标注者</th>
                    <th>标注时间</th>
                    <th>状态</th>
                    <th>操作</th>
                </thead>
                <tbody>
                    <tr ng-repeat="wi in query_wait_intervene.query_list" ng-if="now_package_type == 'query' " id="tr_query_{{wi.id}}">
                        <td style="text-align:left" title="{{wi.query}}"><a href="" ng-click="query_edit_func(wi.id, now_status)">{{wi.query | limitTo:10}}<span ng-if="wi.query.length>10">...</span></a></td>
                        <td>{{wi.intent}}</td>
                        <td ng-bind-html="wi.slots_format | to_trusted"></td>
                        <td>{{wi.user_id}}</td>
                        <td>{{wi.update_time}}</td>
                        <td ng-if="wi.status==0 ">已验证</td>
                        <td ng-if="wi.status==2 ">未验证</td>
                        <td><span class="glyphicon glyphicon-trash" ng-click="del_query(query_wait_intervene.package_id, wi.id, 'wait', query_wait_intervene.this_page, now_status)"></span></td>
                    </tr>
                    <tr ng-repeat="wi in query_wait_intervene.query_list" ng-if="now_package_type == 'eval_query' " id="tr_query_eval_{{wi.id}}">
                        <td style="text-align:left" title="{{wi.query}}"><a href="" ng-click="query_edit_func(wi.id, now_status)">{{wi.query | limitTo:10}}<span ng-if="wi.query.length>10">...</span></a></td>
                        <td>{{wi.intent}}</td>
                        <td>{{wi.intent_m}}</td>
                        <td ng-if="wi.intent_match =='yes' " style="color:red">{{wi.intent_match}}</td>
                        <td ng-if="wi.intent_match !='yes' ">{{wi.intent_match}}</td>
                        <td ng-bind-html="wi.slots_format | to_trusted"></td>
                        <td ng-bind-html="wi.slots_format_m | to_trusted"></td>
                        <td ng-if="wi.slots_match.slots_match_num == wi.slots_match.slots_num && wi.slots_match.slots_num=='0'">
                        null</td>
                        <td ng-if="wi.slots_match.slots_match_num == wi.slots_match.slots_num && wi.slots_match.slots_num!='0'">
                        yes</td>
                        <td ng-if="wi.slots_match.slots_match_num != wi.slots_match.slots_num">
                        no<br>
                        正确识别槽位数：{{wi.slots_match.slots_match_num}}<br>
                        人工标注槽位数：{{wi.slots_match.slots_num}}</td>
                        <!--<td ng-if="wi.slots_match =='yes' " style="color:red">{{wi.slots_match}}</td>
                        <td ng-if="wi.slots_match !='yes' ">{{wi.slots_match}}</td>-->
                        <td>{{wi.user_id}}</td>
                        <td>{{wi.update_time}}</td>
                        <td ng-if="wi.status==0 ">已验证</td>
                        <td ng-if="wi.status==2 ">未验证</td>
                        <td><span class="glyphicon glyphicon-trash" ng-click="del_query(query_wait_intervene.package_id, wi.id, 'wait', query_wait_intervene.this_page, now_status)"></span></td>
                    </tr>
                </tbody>
            </table>
            <br>
            <div class="row col-md-12">
                <div class="btn-group">
                    <button class="btn btn-default" ng-click="get_labeldata_list(now_package_type, now_package_id, 1, now_status);"><i class="glyphicon glyphicon-step-backward"></i> 首页</button>
                    <button class="btn btn-default" ng-click="get_labeldata_list(now_package_type, now_package_id, query_wait_intervene.pre_page, now_status);"><i class="glyphicon glyphicon-chevron-left"></i> 上一页</button>
                    <button class="btn btn-primary">{{query_wait_intervene.this_page}}</button>
                    <button class="btn btn-default" id="btn_next_page" ng-click="get_labeldata_list(now_package_type, now_package_id, query_wait_intervene.next_page, now_status);">下一页 <i class="glyphicon glyphicon-chevron-right"></i></button>
                    <button class="btn btn-default" ng-click="get_labeldata_list(now_package_type, now_package_id, query_wait_intervene.pageall, now_status);">末页 <i class="glyphicon glyphicon-step-forward"></i></button>
                    <button class="btn btn-default disabled">(共 {{query_wait_intervene.pageall}}页 / 共 {{query_wait_intervene.total}} 项)</button>
                    <div class="input-group col-md-2">
                        <input type="text" class="form-control" id="query_wait_intervene_goto_page" value="{{goto_some_page_intervention}}" placeholder="跳转页" ng-model="goto_some_page_intervention">
                        <span class="input-group-btn">
                            <button class="btn btn-default" type="button" ng-click="get_labeldata_list(now_package_type, now_package_id, goto_some_page_intervention, now_status);" ><span class="glyphicon glyphicon-arrow-right" ></span></button>
                        </span>
                    </div>
                </div>
            </div>
            </br>
            </br>
            </br>
            </br>
            </br>

        </div>
        <!-- end col-md-12 -->
    </div>
    <!-- end row-->

    </div>
    <style>
    .btn-wordseg {
        margin-top: 1%;
        margin-right: -1px;
    }
    .sorting {
        background: url('/static/images/sort_both.png') no-repeat right;
        cursor: pointer !important;
    }
    .sorting_asc {
        background: url('/static/images/sort_asc.png') no-repeat right;
        cursor: pointer !important;
    }
    .sorting_desc {
        background: url('/static/images/sort_desc.png') no-repeat right;
        cursor: pointer !important;
    }
    </style>
    <link rel="stylesheet" href="/static/css/metroStyle.css" type="text/css">
    <link rel="stylesheet" href="/static/css/demo.css" type="text/css">
    <script type="text/javascript" src="/static/js/jquery.ztree.core.js"></script>
    <script type="text/javascript" src="/static/js/jquery.ztree.excheck.js"></script>
    <script type="text/javascript" src="/static/js/jquery.ztree.exedit.js"></script>

    <script>
    // $('#zhedie_button').click()
    // function change_button(obj){
    //     obj = jQuery(obj);
    //     alert(obj.html());
    //     if (obj.html() == '展开'){
    //         obj.html('折叠')
    //     }
    //     else{
    //         obj.html('展开')
    //     }
    // }

    $(document).ready(function() {
        $("#wait_intervene").focus();
    })
    $('#editable-select-add-intent').editableSelect();

    function trim(str) { //删除全部空格
        var result;
        var is_global = "g";
        result = str.replace(/(^\s+)|(\s+$)/g, "");
        if (is_global.toLowerCase() == "g") {
            result = result.replace(/\s/g, "");
        }
        return result;
        //return str.replace(/(^\s*)|(\s*$)/g, "");
    }

    function copy_tr() {
        //var h = $("#copyTr").html();
        //h = h.replace("query-slot-tr copyTr", "query-slot-tr");
        var intent = $("#editable-select-add-intent-no-func-slot").val();
        var appid = $("#app_id").val();
        var query = $("#wait_intervene");
        var ori_query = trim($("#wait_intervene").val());
        var func_slot = $("#now_func_slot").val();

        // if( intent == "" || intent == "null" || typeof intent == "undefined")
        // {
        //     alert("请先选择意图");
        //     return false;
        // }
        if (ori_query == "") {
            alert("请先输入query");
            return false;
        }

        var ctr = "<tr>" + $("#copyTr").html() + "</tr>";
        $("#slot_tbody").append(ctr);

        //alert(ctr);
        //var slot_tbody = $("#slot_tbody").html();

        //slot_recommend_word(ori_query, appid, intent, func_slot, , select_obj)
        // if(select_obj.length <= 1)
        // {
        //     var default_slot_list = $("#default_slot_list").html();
        //     console.log(default_slot_list);
        //     select_obj.html(default_slot_list);
        //     select_obj.editableSelect();
        // }
        // select_obj.each(function(index, element)
        // {
        //     select_obj.append("<option value='text'>test</option>")
        //     select_obj.editableSelect();
        // });
        //slot_recommend();

        //select_obj = $("#slot_table").find("tr:last").find("select");
        // if(select_obj.length <= 1)
        // {
        //     var default_slot_list = $("#default_slot_list").html();
        //     console.log(default_slot_list);
        //     select_obj.html(default_slot_list);
        //     select_obj.editableSelect();
        // }
    }

    function click_check_ok_btn() {
        console.log("click click_check_ok_btn function");
        $("#slot_table").find("input").each(function(index, element) {
            if (jQuery(element).attr("check_ok") == "no") {
                jQuery(element).attr("check_ok", "yes");
            }
        });
        $("#word_seg_res_check_flag").attr("value", "no");
    }

    function copy_tr_by_word(btn_obj, word) {
        //var h = $("#copyTr").html();
        //h = h.replace("query-slot-tr copyTr", "query-slot-tr");
        var intent = $("#editable-select-add-intent-no-func-slot").val();
        var appid = $("#app_id").val();
        var query = $("#wait_intervene");
        var ori_query = trim($("#wait_intervene").val());
        var func_slot = $("#now_func_slot").val();
        var btn = jQuery(btn_obj);
        var id = btn.attr("id");
        // if( intent == "" || intent == "null" || typeof intent == "undefined")
        // {
        //     alert("请先选择意图");
        //     return false;
        // }
        if (ori_query == "") {
            alert("请先输入query");
            return false;
        }

        //如果可以创建新的槽位
        var word_seg_res_check_flag = $("#word_seg_res_check_flag").val();
        console.log(word_seg_res_check_flag);

        //先判断是否有槽位
        var table = $("#slot_table");
        var last_tr;
        if (table.find("tr").length > 2 && word_seg_res_check_flag == 'yes') { //>2 默认有1行隐藏的数据，最后一次的输入框，不一定是最后一行，有可能用户后选择前面的词，查找check_ok="no"，全部只能有一个check_ok == no
            last_tr = table.find("tr:last");
            console.log("last_tr1:")
            console.log(last_tr);
            var tr_list = table.find("tr");
            for (var i = 0; i < tr_list.length; i++) {
                if (i < 1) continue;
                //console.log(jQuery(tr_list[i]).find("input"));
                var tmp_tr = jQuery(tr_list[i]).find("input:last");
                //console.log(tmp_tr.attr("check_ok"));
                if (tmp_tr.attr("check_ok") == "no") {
                    last_tr = jQuery(tr_list[i]);
                    break;
                }
            }
            console.log("last_tr2:")
            console.log(last_tr);
        } else {
            //复制一行
            last_tr = $("#copyTr").clone(true);
        }
        //找到最后一行
        var last_input = jQuery(last_tr.find("input:last"));

        //计算offset和length并保存，便于删除的时候点亮 分词结果 中的按钮
        var word_start_length_list = last_input.attr("word_start_length_list");
        var btn_id_list = last_input.attr("btn_id_list");
        //判断点击的词的顺序
        var btn_id_list_obj = btn_id_list.split("#");
        var last_btn_id_num = btn_id_list_obj[btn_id_list_obj.length-1].split("_")[4];
        // for (var i = 0; i < btn_id_list_obj.length; i++) {
        //     if (btn_id_list_obj[i] != "") {
        //         last_btn_id_num = btn_id_list_obj[i].split("_")[4];
        //         break;
        //     }
        // }
        var id_num = id.split("_")[4];
        // if(last_btn_id_num >= id_num)
        // {
        //     alert("不能选择前面的词");
        //     return false;
        // }
        console.log("id_num:" + id_num);
        console.log("last_btn_id_num:" + last_btn_id_num);
        console.log("check_ok:" + last_input.attr("check_ok"));
        console.log(parseInt(id_num) > parseInt(last_btn_id_num) + 1);
        console.log(last_input.attr("check_ok") == "no");
        console.log(word);
        var combine_flag = false;

        if ((parseInt(id_num) < parseInt(last_btn_id_num) - 1) && word_seg_res_check_flag == 'yes') { //  今天   天气  怎么样
            //    点击   怎么样     今天
            console.log("跨词（前面）");
            click_check_ok_btn();
            $("#word_seg_res_check_flag").attr("value", "no");
            word_seg_res_check_flag = "no"; {
                //复制一行
                console.log("复制一行");
                last_tr = $("#copyTr").clone(true);
            }
            //找到最后一行的输入框
            last_input = jQuery(last_tr.find("input:last"));

            //计算offset和length并保存，便于删除的时候点亮 分词结果 中的按钮
            word_start_length_list = ""; //last_input.attr("word_start_length_list");
            btn_id_list = "";
        }
        if (parseInt(id_num) == parseInt(last_btn_id_num) - 1) { //  今天   天气  怎么样
            //    点击   天气  今天
            //    或者
            //    点击   怎么样   天气  今天
            // 都要按照   今天天气怎么样   的顺序来展现

            console.log("前一个词");
            combine_flag = true;
        } else if (parseInt(id_num) > parseInt(last_btn_id_num) + 1 && last_input.attr("check_ok") == "no") {
            console.log("跨词（后面）");
            click_check_ok_btn();
            $("#word_seg_res_check_flag").attr("value", "no");
            word_seg_res_check_flag = "no"; {
                //复制一行
                console.log("复制一行");
                last_tr = $("#copyTr").clone(true);
            }
            //找到最后一行的输入框
            last_input = jQuery(last_tr.find("input:last"));

            //计算offset和length并保存，便于删除的时候点亮 分词结果 中的按钮
            word_start_length_list = ""; //last_input.attr("word_start_length_list");
            btn_id_list = "";
        }

        console.log("combine_flag:" + combine_flag);
        //按钮变灰
        btn.attr("disabled", "");
        console.log("word_start_length_list:" + word_start_length_list);
        console.log("word_seg_res_check_flag:" + word_seg_res_check_flag);
        var slot = {};
        slot.word = word;
        slot.length = btn.attr("word_length");
        slot.offset = btn.attr("word_offset")
        if (combine_flag == false) {
            last_input.attr("word_start_length_list", word_start_length_list + "#" + slot.offset + "_" + slot.length);
            last_input.attr("btn_id_list", btn_id_list + "#" + id);
        } else {
            last_input.attr("word_start_length_list", "#" + slot.offset + "_" + slot.length + word_start_length_list);
            last_input.attr("btn_id_list", "#" + id + btn_id_list);
        }

        if (word_seg_res_check_flag == 'yes') { //在最后一行的输入框中添加文字
            var tmp_word = last_input.attr("value");
            if (combine_flag == false) {
                last_input.attr("value", tmp_word + word);
            } else {
                last_input.attr("value", word + tmp_word);
                combine_flag = false;
            }

            //用于点击 确认 按钮
            last_input.attr("check_ok", "no");
            if (table.find("tr").length == 2) {
                var ctr = "<tr>" + last_tr.html() + "</tr>";
                table.append(ctr);
            }
        } else { //新增一行
            console.log("add new line");
            click_check_ok_btn();
            last_input.attr("value", word);
            last_input.attr("check_ok", "no");
            //console.log(last_tr.html());
            var ctr = "<tr>" + last_tr.html() + "</tr>";
            table.append(ctr);
        }
        $("#word_seg_res_check_flag").attr("value", "yes");
        //if ($("#slot_tbody").find("tr").length > 2) {
        do_tr_order();
        //}

        //焦点应该还要聚焦在分词，如果没有分词结果，则聚焦到槽位中
        var wordseg_num = focus_wordseg_res();
        if(wordseg_num == -1)
        {
            focus_slots_info();
        }

    }

    function do_tr_order() {
        //对生成的行进行排序，之后加入tabindex
        var tr = $("#slot_tbody").find("tr");
        var tbody = $("#slot_tbody");
        var new_tr = [];
        var first_tr;
        tr.each(function(index, element) {
            if (index == 0) {
                first_tr = jQuery(element);
            }
            if (index > 0) {
                trs = {}
                var tr_obj = jQuery(element);
                trs.tr = tr_obj;

                var btn_id_list_str = jQuery(jQuery(element).find("input")[1]).attr("btn_id_list");
                var btn_id_list = btn_id_list_str.split("#");
                var id = "";
                for (var i = 0; i < btn_id_list.length; i++) {
                    if (btn_id_list[i] != "") {
                        tmp = btn_id_list[i].split("_");
                        id = parseInt(tmp[tmp.length-1]);
                        break;
                    }
                }
                trs.id = id;
                new_tr.push(trs);
                console.log("push:" + trs.id);
            }
        })
        console.log(new_tr);
        new_tr = quickSort(new_tr);
        console.log(new_tr);
        tbody.html("");
        tbody.append(first_tr);
        var order = 1000;
        for (var i = 0; i < new_tr.length; i++) {
            var tmp_tr = jQuery(new_tr[i].tr);
            tmp_tr.find("select").attr("tabindex", order); //槽位选择
            order += 1;
            tmp_tr.find("button").attr("tabindex", order); //删除按钮
            order += 1;
            //为tab的顺序，从1000开始加
            tbody.append(new_tr[i].tr);
        }

    }

    var quickSort = function(arr) {
        if (arr.length <= 1) return arr; // 递归停止条件
        // 选取基准值
        var pivotIndex = Math.ceil(arr.length / 2);
        var pivot = arr.splice(pivotIndex, 1)[0]; // 基准值
        var left = [],
            right = [];

        // 如果大于基准值，移到数组right中；小于基准的值，移到数组left中
        for (var i = 0; i < arr.length; i++) {
            arr[i].id > pivot.id ? right.push(arr[i]) : left.push(arr[i]);
        }

        return quickSort(left).concat([pivot], quickSort(right));

    };

    function clear_tr() {
        var vtr = $("#slot_tbody").children("tr").find("input");
        var i = 1;
        vtr.each(function(index, element) {
            if (index > 1 && element.name == "word") {
                $("#slot_tbody").find("tr:last").remove();
            }
        })
    }

    $("#intertBtn").click(function() {
        //copy_tr();
        copy_tr_by_word();
    });

    function qu_slot_delete_old(obj) {
        jQuery(obj).parent().parent().remove()
    }

    function qu_slot_check_ok(obj) {
        //用户点击确认按钮
        var btn_check = jQuery(obj).remove();
        $("#word_seg_res_check_flag").attr("value", "no");
    }

    function check_table_no_tr() { //判断如果没有槽位，设置为可以添加新槽位的flag
        var table = $("#slot_table");
        if (table.find("tr").length == 2) {
            $("#word_seg_res_check_flag", "yes");
        }
    }

    function qu_slot_delete(obj) {
        //通过获取删除这行的input框中的id列表，把分词结果中对应id的词点亮
        var last_input = jQuery(obj).parent().parent().find("input:last");
        var btn_id_list = last_input.attr("btn_id_list").split("#");
        for (var i = 0; i < btn_id_list.length; i++) {
            $("#" + btn_id_list[i]).removeAttr("disabled");
        }
        jQuery(obj).parent().parent().remove();

        check_table_no_tr();
        click_check_ok_btn();
        $("#word_seg_res_check_flag", "no");
    }

    function get_seg_btn(val, index, word_offset, word_length) {
        var tabindex = 600 + index;
        var btn = '<button  class="btn btn-xs btn-default btn-wordseg" class="btn-xs" click_flag="false" onclick="copy_tr_by_word(this, ' + "'" +
            val + "'" + ')" id="word_seg_res_word_' + index + '" word_offset="' + word_offset + '" word_length="' + word_length + '" tabindex="' + tabindex + '">' + val + '</button>';
        return btn;
    }

    function get_slot_info(ori_query, wordseg_res) { //对分词结果获取偏移量和长度
        var slots = [];
        var slot = {};
        var now_index = 0;
        for (var i = 0; i < wordseg_res.length; i++) {
            slot = {};
            slot.word = wordseg_res[i];
            slot.length = gbkBytes(slot.word);
            var index = ori_query.indexOf(slot.word, now_index);
            var sub = ori_query.substring(0, index);
            slot.offset = gbkBytes(sub);
            now_index += slot.word.length;
            console.log(now_index + " " + wordseg_res[i] + " index:" + index);
            slots.push(slot);
        }
        console.log(slots);
        return slots

    }

    function wordseg_new() {
        var appid = $("#app_id").val();
        var query = $("#wait_intervene");
        var last_query = trim($("#now_query").val());
        var ori_query = trim($("#wait_intervene").val());
        query.val(ori_query);
        if(ori_query == last_query){
            return;
        }
        var url = "/intervene/wordseg";
        var wordseg_res = "";
        var word_seg_res_btn = $("#word_seg_res_btn_list");
        word_seg_res_btn.html("");
        $.ajax({
            url: url,
            type: 'post', //提交的方式
            dataType: 'json',
            data: {
                "query": ori_query,
            },
            success: function(msg) {
                //这是成功返回的数据，写自己的逻辑
                if (msg["errno"] == 0) {
                    wordseg_res = msg["wordseg"].split("  ");
                    slots = get_slot_info(ori_query, wordseg_res);
                    for (var i = 0; i < wordseg_res.length; i++) {
                        word_seg_res_btn.append(get_seg_btn(wordseg_res[i], i, slots[i].offset, slots[i].length));
                        $("#btn_check_ok_div").attr("style", "");
                    }
                    //set_slots(wordseg_res);
                } else if (msg["errno"] == 4) {
                    //alert(msg["msg"]);
                } else {
                    alert("error");
                }
            },
            error: function(msg) {
                alert("fail");
            }
        });

    }

    function wordseg() {
        var appid = $("#app_id").val();
        var query = $("#wait_intervene");
        var ori_query = trim($("#wait_intervene").val());
        var url = "/intervene/wordseg";
        var wordseg_res = ori_query;
        $.ajax({
            url: url,
            type: 'post', //提交的方式
            dataType: 'json',
            data: {
                "query": ori_query,
            },
            success: function(msg) {
                //这是成功返回的数据，写自己的逻辑
                if (msg["errno"] == 0) {
                    query.val(msg["wordseg"]);
                    wordseg_res = msg["wordseg"];
                    //intent_recomend();
                    set_slots(wordseg_res);
                } else if (msg["errno"] == 4) {
                    //alert(msg["msg"]);
                } else {
                    alert("error");
                }
            },
            error: function(msg) {
                alert('fail');
            }
        });

    }

    function intent_recomend() {
        var appid = $("#app_id").val();
        var ori_query = trim($("#wait_intervene").val());
        url = "/intervene/intentrecommend";
        $.ajax({
            url: url,
            type: 'post', //提交的方式
            dataType: 'json',
            data: {
                "query": ori_query,
                "appid": appid
            },
            success: function(msg) {
                //这是成功返回的数据，写自己的逻辑
                if (msg.length > 0) {
                    var select_parent = $("#editable-select-add-intent").parent();
                    var select_intent_old = $("#editable-select-add-intent").parent().children().remove();

                    var select_html = '<select id="editable-select-add-intent" class="form-control" placeholder="选择或者输入一个意图" onblur="bind_intent_func_slot(' + "'" + 'editable-select-add-intent' + "','" + 'now_func_slot' + "'" + ')"></select>';
                    select_parent.html(select_html);
                    var select_intent = $("#editable-select-add-intent");
                    var option_first = "";
                    var option = "";
                    var option_first_tag = false;
                    for (var i = 0; i < msg.length; i++) {
                        if (msg[i].status == "1") {
                            option_first = "<option onclick='set_slots_twice();' value='" + msg[i].intent_name + ":" + msg[i].func_slot + "' style='color:red'><span style='color:red'>" + msg[i].intent_name + "</span></option>";
                            option_first_tag = true;
                        } else if (msg[i].status == "2") {
                            option = "<option onclick='set_slots_twice();' value='" + msg[i].intent_name + ":'>" + msg[i].intent_name + "</option>";
                        } else if (msg[i].status == "0") {
                            option = "<option onclick='set_slots_twice();' value='" + msg[i].intent_name + ":'" + msg[i].func_slot + ">" + msg[i].intent_name + "</option>";
                        }
                        if (option != "") {
                            select_intent.append(option);
                        }
                        option = "";
                    }
                    if (option_first_tag) {
                        select_intent.prepend(option_first);
                    }
                    $("#editable-select-add-intent").editableSelect();
                }

            },
            error: function(msg) {
                alert("fail");
            }
        });
    }

    function set_slots_twice_old() {
        wordseg_res = $("#wait_intervene").val();
        clear_tr();
        set_slots(wordseg_res);
        //slot_recommend();
    }

    function set_slots_twice() {
        wordseg_res = $("#wait_intervene").val();
        clear_tr();
        //set_slots(wordseg_res);
        //slot_recommend();
    }

    function set_slots(wordseg_res) {
        words = wordseg_res.split("  ");
        for (var i = 0; i < words.length; i++) {
            //words[i]
            copy_tr();
        }
        //slot_recommend();
        var obj = $("#slot_tbody").children("tr").find("input");
        var i = 0;
        obj.each(function(index, element) {
            if (element.name == "word" && index > 2) {
                element.value = words[i];
                i += 1;
            }
        });
    }

    function slot_recommend() {
        var appid = $("#app_id").val();
        var ori_query = trim($("#wait_intervene").val());
        var intent = $("#editable-select-add-intent").next().children("li.ng-binding.ng-scope.es-visible").attr("value");
        if (typeof intent == "undefined") {
            var intent_obj = $("#editable-select-add-intent").next().children();
            intent_obj.each(function(index, element) {
                if (element.className.indexOf("es-visible") >= 0) {
                    intent = jQuery(element).attr("value");
                }
            });

        }
        var intent_name = trim(intent.split(":")[0]);
        var func_slot = trim(intent.split(":")[1]);
        if (func_slot == "") {
            func_slot = $("#now_func_slot").val();
        }
        var obj_word = $("#slot_tbody").children("tr").find("input");
        var j = 0;
        var words = [];
        var obj = $("#slot_tbody").children("tr").find("input");
        var i = 1;
        var option_first_tag = false;
        var option_first = "";
        j = 0;
        obj.each(function(index, element) {
            if (element.name == "word" && index > 2) {
                //alert(intent_name + " " + ori_query + " " + element.value);
                //var obj_option = jQuery($("#slot_tbody").children("tr").find("select")[]);
                var obj_option = jQuery(element).parent().next();
                console.log(obj_option);
                slot_recommend_word(ori_query, appid, intent_name, func_slot, element.value, obj_option);
                j += 1;
            }
        });
    }

    function slot_recommend_word(ori_query, appid, intent_name, func_slot, cur_term, obj_option) {
        console.log(cur_term);
        url = "/intervene/slotrecommend";
        $.ajax({
            url: url,
            type: 'post', //提交的方式
            dataType: 'json',
            async: false,
            data: {
                "query": ori_query,
                "appid": appid,
                "func_slot": func_slot,
                "intent_name": intent_name,
                "cur_term": cur_term
            },
            success: function(msg) {
                //这是成功返回的数据，写自己的逻辑
                var obj_option_select = obj_option.find("select");
                var obj_option_ul = obj_option.find("ul");
                console.log("msg.length:" + msg.length);
                console.log(obj_option.find("select"));
                console.log(obj_option.length);
                if (msg.length > 0 && obj_option_select.length > 0) {
                    obj_option_select.empty();
                    var option_first_tag = false;
                    var option_first = "";
                    for (var j = 0; j < msg.length; j++) {
                        if (msg[j].status == '2') {
                            option_first = msg[j].slot_name;
                            option_first_tag = true;
                            obj_option_select.prepend("<option value='" + option_first + "' style='color:red'><span style='style:red'>" + option_first + "</span></option>");
                        }
                        if (msg[j].status == '0') {
                            option = msg[j].slot_name;
                            obj_option_select.append("<option value='" + option + "'>" + option + "</option>");
                        }

                    }
                    if (option_first_tag) {}
                    console.log(obj_option);
                    console.log(obj_option.length);
                    obj_option_select.editableSelect();

                }

                if (msg.length > 0 && obj_option_select.length == 0) {
                    console.log(obj_option_ul);
                    obj_option_ul.html("");
                    for (var j = 0; j < msg.length; j++) {
                        if (msg[j].status == '2') {
                            option_first = msg[j].slot_name;
                            option_first_tag = true;
                            obj_option_ul.prepend("<li value='" + option_first + "' style='color:red' class='es-visible'> " + option_first + "</li>");
                        }
                        if (msg[j].status == '0') {
                            option = msg[j].slot_name;
                            obj_option_ul.append("<li value='" + option + "class='es-visible'>" + option + "</li>");
                        }

                    }
                }
            },
            error: function(msg) {
                alert("fail");
            }
        });
    }

    function do_wordseg() {
        var query = $("#wait_intervene");
        var last_query = trim($("#now_query").val());
        var ori_query = trim($("#wait_intervene").val());
        if(ori_query == last_query){
            return;
        }
        clear_tr();
        //wordseg();
        wordseg_new();
    }

    function bind_intent_func_slot(intent_id, func_slot_id) {
        func_map = {
            "info-ynq": "用户主动单轮-信息查询类-是非问(info-ynq)",
            "info-slctq": "用户主动单轮-信息查询类-比较/选项问(info-slctq)",
            "info": "用户主动单轮-信息查询类-其他查询问(info)",
            "exe": "用户主动单轮-请求行为类(exe)",
            "update": "用户主动多轮-信息更新类(update)",
            "ans-info": "BOT主动多轮-用户答复类-提供信息(ans-info)",
            "ans-yn": "BOT主动多轮-用户答复类-是非答复(ans-yn)",
            "null": "请选择",
        }
        var val = $("#editable-select-add-intent").next().children("li.ng-binding.ng-scope.es-visible").attr("value");
        if (typeof val == "undefined") {
            var val_obj = $("#editable-select-add-intent").next().children();
            val_obj.each(function(index, element) {
                if (element.className.indexOf("es-visible") >= 0) {
                    val = jQuery(element).attr("value");
                }
            });
        }
        var name_func = val.split(":");
        //alert($("#"+intent_id).val() + " " + name_func[0] + " " + name_func[1]);
        if (name_func[1] == "") name_func[1] = "null";
        $("#" + func_slot_id).val(func_map[name_func[1]]);

        $("#now_func_slot option").each(function() {
            //alert($(this).val() + "  " + name_func[1]);
            $(this).removeAttr("selected");
            if ($(this).val() == name_func[1]) {
                $(this).prop("selected", true);
                console.log("slotrecommend from bind_intent_func_slot");
                slot_recommend();
            }
        });
    }
    var merge_history = new Array();

    function cancel_merge() {

        do_wordseg();
        return;
        // if (merge_history.length == 0){
        //     return;
        // }
        // // alert(merge_history.length)
        // var trs = merge_history.pop();
        // // console.log(trs)
        // var obj_word = $("#slot_tbody").children("tr");
        // obj_word.each(function(index, element) {
        //     if (index >= 1){
        //         jQuery(element).remove();
        //     }
        // });
        // var l = trs.length;
        // var ctr = "<tr>" + $("#copyTr").html() + "</tr>";
        // for (var i = 0; i < trs.length; i++){
        //     $("#slot_tbody").append(ctr);
        // }
        // var count = 0;
        // var obj_word = $("#slot_tbody").children("tr").find("input");
        // obj_word.each(function(index, element) {
        //         if (element.name == "slotMerge" && index > 1) {
        //             // console.log(trs[count])
        //             jQuery(element).next().val(trs[count]);
        //             count++;
        //         }

        //     });

    }

    function merge_slot_word() {
        var obj_word = $("#slot_tbody").children("tr").find("input");

        var trs = new Array();
        obj_word.each(function(index, element) {
            if (element.name == "slotMerge" && index > 1) {
                trs.push(jQuery(element).next().val());
            }
        });
        var word = "";
        var merge_time = 0;
        var which_one = 0;
        var sub_num = 0;
        obj_word.each(function(index, element) {
            if (element.name == "slotMerge" && index > 1 && element.checked == true) {
                word += jQuery(element).next().val();
                merge_time += 1;
                if (merge_time == 1) {
                    which_one = index;
                }
                if (merge_time > 1) {
                    jQuery(element).closest("tr").remove();
                    sub_num += 1;
                    merge_history.push(trs);
                    //alert("remove");
                }
                //element.checked = false;
            }

        });
        var merge_tag = false;
        obj_word.each(function(index, element) {
            if (element.name == "slotMerge" && index > 1 && element.checked == true && !merge_tag) {
                jQuery(element).next().val(word);
                merge_tag = true;
                element.checked = false;
            }

        });
        console.log("slotrecommend from merge_slot_word");
        slot_recommend();
        // obj_word.each(function(index, element) {
        //     console.log(index + " " + element.name + " "+ element.value);
        //     if (element.name == "word" && index > 1 && element.checked == true) {
        //         if (merge_tag == false) {
        //             console.log(which_one - sub_num - 1);
        //             console.log(index);
        //             merge_tag = true;
        //             element.value = word;
        //         }
        //         element.checked = false;
        //     }

        // });

        // console.log(which_one + " " + word + " " + sub_num);
        // obj_word.each(function(index, element) {

        //     if (element.name == "word" && !merge_tag) {
        //         console.log(which_one - sub_num - 1);
        //         console.log(index);
        //         merge_tag = true;
        //         element.value = word;
        //     }
        // });
    }

    function gbkBytes(str) {
        var realLen = 0;
        var len = str.length;
        for (var i = 0; i < len; i++) {
            var charCode = str.charCodeAt(i);
            if (charCode >= 0 && charCode <= 128) {
                realLen += 1;
            } else {
                realLen += 2;
            }
        }
        return realLen;
    }

    function query_all() {
        document.getElementById("query_form").reset();
        clear_tr();
        $("#word_seg_res_btn_list").html("");
    }

    function click_save_query_btn(e) {
        // 兼容FF和IE和Opera
        // var theEvent = e || window.event;
        // var code = theEvent.keyCode || theEvent.which || theEvent.charCode;
        console.log("click click_save_query_btn function");
        $("#btn_query_intervention_page_save").click();
        //$("#bot_msg").select();
        $("#btn_query_intervention_page_save").focus();

    }

    // $("#query_intervention_page_top").bind("keydown",function(e){
    //         console.log("query_intervention_page_top");
    //         click_save_query_btn(e);
    //     });
    // $("#query_intervention_page_bottom").bind("keydown",function(e){
    //         console.log("query_intervention_page_bottom");
    //         click_save_query_btn(e);
    //     });
    // $("#query_intervention_page_right").bind("keydown",function(e){
    //         console.log("query_intervention_page_right");
    //         click_save_query_btn(e);
    //     });
    // $("#intervention-query").keypress(function(event){
    //     if (event.which == 13 && event.ctrlKey)
    //     {
    //         console.log("x");
    //         click_save_query_btn(event);
    //         //click_check_ok_btn_event(event);
    //     }
    // })
    function focus_wordseg_res(){
        var words = $("#word_seg_res_btn_list").children();
        var flag = -1;
        for(var i=0;i<words.length;i++)
        {
            if(typeof jQuery(words[i]).attr("disabled") != "undefined")
            {

            }
            else
            {
                flag = i
                break;
            }
        }
        if(flag != -1)
        {
            jQuery(words[i]).focus();
        }
        return flag;
    }
    function focus_slots_info(){
        var select = $("#slot_table").find("select");
        if(select.length > 0)
        {
            jQuery(select[1]).focus();
        }
        $("#slot_table").focus();
    }
    $(document).ready(function(){
        var active_element = jQuery(document.activeElement)
        var tabindex = active_element.attr("tabindex");
        console.log("in keydown:  id: " + active_element.attr("id") + " tabindex:" + tabindex);
        $(document).jkey('ctrl+1',function(){
            $("#wait_intervene").focus();
        });
        $(document).jkey('ctrl+2',function(){
            $("#editable-select-add-intent-no-func-slot").focus();
        });
        $(document).jkey('ctrl+3',function(){
            focus_wordseg_res();
        });
        $(document).jkey('ctrl+4',function(){
            focus_slots_info();
        });
        $(document).keydown(function(event) {

            var e = event || window.event;
            var key = e.keyCode || e.which;
            if (e.altKey && key == 191) {
                console.log("alt + /")
                click_check_ok_btn(); //点击  分词结果中的确认键
            } else if (key == 13) {
                click_save_query_btn(); // 点击  保存 按钮
            }

            // if(9 == key)
            // {
            //     console.log("now: id: " + active_element.attr("id") + "  tabindex: "+ tabindex);
            //     if(parseInt(tabindex, 10) < 400 ){
            //         if (e.which) {//火狐
            //         e.preventDefault();
            //         } else {//IE、Chrome
            //             e.returnValue = false;
            //         }
            //     }
            // }
            // active_element = jQuery(document.activeElement)
            // tabindex = active_element.attr("tabindex");

        })


    })

    </script>
