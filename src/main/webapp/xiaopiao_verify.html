<!DOCTYPE html>
<!-- saved from url=(0048)http://unit.baidu.com/appservice/index?appid=728 -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style type="text/css">@charset "UTF-8";[ng\:cloak],[ng-cloak],[data-ng-cloak],[x-ng-cloak],.ng-cloak,.x-ng-cloak,.ng-hide:not(.ng-hide-animate){display:none !important;}ng\:form{display:block;}.ng-animate-shim{visibility:hidden;}.ng-anchor{position:absolute;}</style>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>xiaopiao_verify    </title>
    <!-- Bootstrap core CSS -->
    <link href="./static/css/bootstrap.css" rel="stylesheet">
    <link href="./static/css/jquery-editable-select.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./static/css/simple-grid.css">
    <!--<link href="/static/css/jquery.jsonview.min.css" rel="stylesheet">-->
    <link href="./static/css/site.css" rel="stylesheet">
    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]>
    <script src="/webapp/static/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="./static/js/ie-emulation-modes-warning.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="./static/js/jquery.min.1.11.js"></script>
   <!-- <script src="./static/js/jquery-editable-select.min.js"></script>-->
    <script src="./static/js/HZRecorder.min.js"></script>
<link type="text/css" rel="stylesheet" href="chrome-extension://pioclpoplcdbaefihamjohnefbikjilc/css/searchhelper.css"><style>#haloword-pron { background: url(chrome-extension://bhkcehpnnlgncpnefpanachijmhikocj/img/icon.svg) -94px -34px; }#haloword-pron:hover { background: url(chrome-extension://bhkcehpnnlgncpnefpanachijmhikocj/img/icon.svg) -111px -34px; }#haloword-open { background: url(chrome-extension://bhkcehpnnlgncpnefpanachijmhikocj/img/icon.svg) -94px -17px; }#haloword-open:hover { background: url(chrome-extension://bhkcehpnnlgncpnefpanachijmhikocj/img/icon.svg) -111px -17px; }#haloword-close { background: url(chrome-extension://bhkcehpnnlgncpnefpanachijmhikocj/img/icon.svg) -94px 0; }#haloword-close:hover { background: url(chrome-extension://bhkcehpnnlgncpnefpanachijmhikocj/img/icon.svg) -111px 0; }#haloword-add { background: url(chrome-extension://bhkcehpnnlgncpnefpanachijmhikocj/img/icon.svg) -94px -51px; }#haloword-add:hover { background: url(chrome-extension://bhkcehpnnlgncpnefpanachijmhikocj/img/icon.svg) -111px -51px; }#haloword-remove { background: url(chrome-extension://bhkcehpnnlgncpnefpanachijmhikocj/img/icon.svg) -94px -68px; }#haloword-remove:hover { background: url(chrome-extension://bhkcehpnnlgncpnefpanachijmhikocj/img/icon.svg) -111px -68px; }</style><style id="style-1-cropbar-clipper">/* Copyright 2014 Evernote Corporation. All rights reserved. */
.en-markup-crop-options {
    top: 18px !important;
    left: 50% !important;
    margin-left: -100px !important;
    width: 200px !important;
    border: 2px rgba(255,255,255,.38) solid !important;
    border-radius: 4px !important;
}

.en-markup-crop-options div div:first-of-type {
    margin-left: 0px !important;
}
</style></head>

<body class="">
    
  <link rel="stylesheet" href="./static/css/metroStyle.css" type="text/css">
   <link rel="stylesheet" href="./static/css/demo.css" type="text/css">
  <script type="text/javascript" src="./static/js/jquery.ztree.core.js"></script>
    <script type="text/javascript" src="./static/js/jquery.ztree.excheck.js"></script>
  <script type="text/javascript" src="./static/js/jquery.ztree.exedit.js"></script>

<!-- <script type="text/javascript" src="/static/js/dataTables.editor.js"></script> -->

<div id="bot_chat_show" style="">

    <input type="hidden" id="userid" value="oliver">
    <div id="bot_chat" class="container" style="margin-left: 30%;position: fixed; min-width: 37.5%;width: 37.5%;margin-bottom: 100px;z-index: 99999;margin-top: 10px;height: 80%;min-height: 500px;">
        <div class="row chat-window col-xs-5 col-md-12" id="chat_window_1" style="margin-left:10px;height: 480px;">
            <div class="col-xs-12 col-md-12">
                <div class="panel panel-default" id="bot_chat_panel" style="height: 480px;">
                    <div class="panel-heading top-bar">
                        <div class="col-md-8 col-xs-8">
                             <h3 class="panel-title"><span class="glyphicon glyphicon-comment"></span> 小票验证</h3>
                        </div>
                        <button type="button" class="btn btn-default btn-lg" data-toggle="modal" href="#myModalCheckAdvance">
                            <span class="glyphicon glyphicon-user"></span>
                            <label id="userid_label">oliver</label>
                        </button>

                    </div>
                    <div class="panel-body msg_container_base" id="bot_msg_content"></div>
                    <div id="msg_end" style="height:0px; overflow:hidden"></div>
                    <div class="panel-footer">
                                <div class="modal fade" id="myModalCheckAdvance" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="color:#333">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <!-- <button type="button" class="close" data-dismiss="modal" ><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button> -->
                                                <h4 class="modal-title" id="myModalLabel">Login</h4>
                                            </div>
                                            <div class="modal-body">
                                                <!--
                                                <form class="ng-pristine ng-valid">
                                                      <div class="form-group">
                                                      <div class="alert alert-info alert-dismissible fade in" role="alert" id="information">
                                                                user_info信息，请准确填写user_info中的内容。格式如下：<br>
                                                                {"your_key1": "your_value1", "your_key2": "your_value2"}
                                                        </div>
                                                        <textarea rows="3" id="advance_user_info" type="text" class="form-control input-sm chat_input" placeholder="请在这里填写user_info的完整内容">{}</textarea>

                                                      </div>
                                                </form>
                                                -->
                                                <a>User name : </a>
                                                <input type="text" id="userid_text"/>
                                                <div class="modal-footer" class="form-control input-sm chat_input">
                                                <button type="button" class="btn btn-danger" onclick="return check_user_info_format()">确认</button>
                                                <button type="button" class="btn btn-default" data-dismiss="modal" id="user_info_cancel" style="display:none">取消</button>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- end modal -->
                            <label id ="voice_erro"></label>
                        <div class="input-group">
                            <textarea rows="3" id="bot_msg" type="text" class="form-control input-sm chat_input" placeholder="请在这里填写对话内容"></textarea><span class="input-group-btn">
                            <button type="button" id="btn-chat-voice"  onmousedown ="voice_mousedown()" onmouseup="voice_mouseup()" class="btn btn-default btn-sm" style="z-index: 999;border: 0;margin-left: -40px;background: transparent;width: 10%;margin-top: 10px;">
                            <img src="./static/img/voice.static.png" id="voice_btn_img" width="30" height="30"></button>
                            <button class="btn btn-primary btn-sm btn-block" id="btn-chat-sent" style="float:right" onclick="send_to_bot(&#39;bot_msg&#39;, &#39;bot_msg_content&#39;)">发送</button>
                            <button class="btn btn-default btn-sm" id="btn-chat" style="float:right" onclick="clear_bot_session(&#39;bot_msg_content&#39;)">清空数据</button>
                            </span>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="json_show" style="display:none">
    <div id="bot_chat" class="container" style="margin-left: 64.8%;position: fixed; min-width: 37.5%;width: 37.5%;margin-bottom: 100px;z-index: 99999;margin-top: 0px;height: 80%;min-height: 300px;">
            <div class="row chat-window col-xs-5 col-md-12" id="chat_window_json" style="margin-left:10px;">
                <div class="col-xs-12 col-md-12" style="">
                    <div class="panel panel-default" id="bot_chat_panel_json" style="height:480px;">
                        <div class="panel-heading top-bar">
                            <div class="col-md-8 col-xs-8">
                                 <h3 class="panel-title"><span class="glyphicon glyphicon-comment"></span> JSON</h3>

                            </div>
                            <button class="btn btn-default" onclick="hidden_json()"><span class="glyphicon glyphicon-arrow-left">返回</span></button>
                        </div>
                        <pre class="panel-body msg_container_base" id="bot_json_content" style="height: 138.92px;overflow:auto">{
  <span class="key">"type":</span> <span class="string">"bot_query"</span>,
  <span class="key">"sample_name":</span> <span class="string">"ibf_qucloud_server"</span>,
  <span class="key">"request_type":</span> <span class="string">"qu_cloud"</span>,
  <span class="key">"user_id":</span> <span class="string">"wanghewei_1490613003000_65655"</span>,
  <span class="key">"query":</span> <span class="string">"123"</span>,
  <span class="key">"user_info":</span> <span class="string">"{}"</span>,
  <span class="key">"version":</span> <span class="string">"1.0"</span>,
  <span class="key">"log_id":</span> <span class="string">"wanghewei_log_1490613016000_32930"</span>,
  <span class="key">"bot-session":</span> <span class="string">""</span>,
  <span class="key">"client-session":</span> <span class="string">"{\"action_sequence\":[],\"cur_query_offset\":-1,\"client_results\":\"\",\"candidate_options\":[]}"</span>,
  <span class="key">"cross-bot-session":</span> <span class="string">""</span>
}</pre>
                    </div>
                </div>
            </div>
    </div>
</div>
<div id="json_list" style="display: none"><div id="json_1490613016000_37729">{
  <span class="key">"type":</span> <span class="string">"bot_query"</span>,
  <span class="key">"sample_name":</span> <span class="string">"ibf_qucloud_server"</span>,
  <span class="key">"request_type":</span> <span class="string">"qu_cloud"</span>,
  <span class="key">"user_id":</span> <span class="string">"wanghewei_1490613003000_65655"</span>,
  <span class="key">"query":</span> <span class="string">"123"</span>,
  <span class="key">"user_info":</span> <span class="string">"{}"</span>,
  <span class="key">"version":</span> <span class="string">"1.0"</span>,
  <span class="key">"log_id":</span> <span class="string">"wanghewei_log_1490613016000_32930"</span>,
  <span class="key">"bot-session":</span> <span class="string">""</span>,
  <span class="key">"client-session":</span> <span class="string">"{\"action_sequence\":[],\"cur_query_offset\":-1,\"client_results\":\"\",\"candidate_options\":[]}"</span>,
  <span class="key">"cross-bot-session":</span> <span class="string">""</span>
}</div></div>
<div id="cookie_list" style="display: none">
</div>
<script src="./static/js/js.cookie.js"></script>
<style>
.chat-window{
    bottom:0;
    float:right;
    margin-left:10px;
}
.chat-window > div > .panel{
    border-radius: 5px 5px 0 0;
}
.icon_minim{
    padding:2px 10px;
}
.msg_container_base{
  background: #e5e5e5;
  margin: 0;
  padding: 0 10px 10px;
  height: 90%;
  overflow-x:hidden;
}
.top-bar {
  background: #666;
  color: white;
  padding: 10px;
  position: relative;
  overflow: hidden;
}
.msg_receive{
    background: white;
    padding-left:0;
    margin-left:0;
}
.msg_sent{
    padding-bottom:29px !important;
    margin-right:0;
    background: #5cb85c;
}
.messages {
  padding: 10px;
  border-radius: 2px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  max-width:100%;
}

.msg_sent > p {
    font-size: 13px;
    margin: 0 0 0.2rem 0;
    color: white;
  }

.messages > p {
    font-size: 13px;
    margin: 0 0 0.2rem 0;
  }
.msg_sent > time {
    font-size: 11px;
    color: #efecec;
}

.msg_receive > time {
    font-size: 11px;
    color: #ccc;
}

.msg_container {
    padding: 10px;
    overflow: hidden;
    display: flex;
}
img {
    display: block;

}
.avatar {
    position: relative;
}
.base_receive > .avatar:after {
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    width: 0;
    height: 0;
    border: 5px solid #FFF;
    border-left-color: rgba(0, 0, 0, 0);
    border-bottom-color: rgba(0, 0, 0, 0);
}
.modal-lg {
    width: 90%;
    height: 90%;
}
.base_sent {
  justify-content: flex-end;
  align-items: flex-end;
}
.base_sent > .avatar:after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 0;
    border: 5px solid white;
    border-right-color: transparent;
    border-top-color: transparent;
    box-shadow: 1px 1px 2px rgba(black, 0.2); // not quite perfect but close
}

.msg_sent > time{
    float: right;
}

.msg_container_base::-webkit-scrollbar-track
{
    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
    background-color: #F5F5F5;
}

.msg_container_base::-webkit-scrollbar
{
    width: 12px;
    background-color: #F5F5F5;
}

.msg_container_base::-webkit-scrollbar-thumb
{
    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,.3);
    background-color: #555;
}

.btn-group.dropup{
    position:fixed;
    left:0px;
    bottom:0;
}
</style>

<script>
window.global_cookie = {};
function syntaxHighlight(json) {
    if (typeof json != 'string') {
        json = JSON.stringify(json, undefined, 2);
    }
    json = json.replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>');
    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function(match) {
        var cls = 'number';
        if (/^"/.test(match)) {
            if (/:$/.test(match)) {
                cls = 'key';
            } else {
                cls = 'string';
            }
        } else if (/true|false/.test(match)) {
            cls = 'boolean';
        } else if (/null/.test(match)) {
            cls = 'null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
    });
}

function auto_refresh()
{
    window.location.reload();
}
//setTimeout('auto_refresh()',30000);
//30s 定时刷新

// $(document).ready(function() {
//     $('#editable-select').editableSelect();
//     var app_obj = angular.module("ngapp-appservice-model", ['ngRoute']);
//     app_obj
//     .config(function($routeProvider, $locationProvider) {
//     $routeProvider
//     .when('/app', {
//         templateUrl: '/static/html/appservice_app.html',
//         controller: 'ngAppserviceApp'
//       })
//     .when('/model', {
//         templateUrl: '/static/html/appservice_model.html',
//         controller: 'ngAppserviceModel'

//     })
//     .otherwise({redirectTo:'/app'});
// });
autodivheight();
function autodivheight(){ //函数：获取尺寸
    //获取浏览器窗口高度
    var winHeight=0;
    if (window.innerHeight)
        winHeight = window.innerHeight;
    else if ((document.body) && (document.body.clientHeight))
        winHeight = document.body.clientHeight;
    //通过深入Document内部对body进行检测，获取浏览器窗口高度
    if (document.documentElement && document.documentElement.clientHeight)
        winHeight = document.documentElement.clientHeight;
    //DIV高度为浏览器窗口的高度
    //document.getElementById("test").style.height= winHeight +"px";
    //DIV高度为浏览器窗口高度的一半
    document.getElementById("bot_chat_panel").style.height= winHeight * 0.7  +"px";
    document.getElementById("bot_json_content").style.height= winHeight *0.92 +"px";

}
window.onresize=autodivheight;

Date.prototype.Format = function(format) {
    var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
    }
    if (/(y+)/.test(format)) {
        format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length))
    }
    for (var k in o) {
        if (new RegExp("(" + k + ")").test(format)) {
            format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length))
        }
    }
    return format;
}

function updateDataTableSelectAllCtrl(table){

    var $table = table.table();
    console.log(table);
    console.log(jQuery(table.rows().nodes()[0]).find('input').is( ":checked" ));


   var $chkbox_all = $('tbody input[type="checkbox"]', $table);
   var $chkbox_checked = $('tbody input[type="checkbox"]:checked', $table);
   var chkbox_select_all  = $('thead input[name="select_all"]', $table).get(0);
   if($chkbox_checked.length === 0){
      try{
      chkbox_select_all.checked = false;
        }
        catch(e){
            return;
        }
      if('indeterminate' in chkbox_select_all){
         chkbox_select_all.indeterminate = false;
      }
  }
}

function RandomNumBoth(){
      var Min = 10000;
      var Max = 99999;
      var Range = Max - Min;
      var Rand = Math.random();
      var num = Min + Math.round(Rand * Range); //四舍五入
      return num;
}

function is_standard(v) {
    //var regexp = '^{(("+[a-zA-Z0-9]+"+\s*:"*[a-zA-Z0-9]+"*\s*)(,\s*"+[a-zA-Z0-9]+"+:\s*"*[a-zA-Z0-9]+"*)*)?}$';
    //var regexp = '^{((\s*"|'+[a-zA-Z0-9_]+"|'+\s*:\s*"|'*[\u4e00-\u9fa5]*[a-zA-Z0-9_]*"|'*\s*)(,\s*"|'*+[a-zA-Z0-9_]+"|'*+\s*:\s*"|'*[\u4e00-\u9fa5]*[a-zA-Z0-9_]*"|'*)*)?}$';
    //return v.match(regexp);
    try
    {
        eval('(' + v + ')');
        return true;
    }
    catch (e)
    {
        return false;
    }

}

function check_user_info_format(){
    var userid = $("#userid_text").val();
    if (userid=="")
    {
    alert("用户名不为空，请检查");
    return false;
    }
    else
    {
        console.log("is a dict");
        document.getElementById("userid").setAttribute("value",userid);
        document.getElementById("userid_label").innerHTML=userid;
        $("#user_info_cancel").trigger("click");
        return true;
    }
}

function setCookie(name,value)
{
    // var Days = 1;
    // var exp = new Date();
    // exp.setTime(exp.getTime() + Days*24*60*60*1000);
    // document.cookie = name + "="+ escape (value) + ";expires=" + exp.toGMTString();
    // var add_obj = "<textarea id='" + name + "' style='display:none'></textarea>";
    // var obj = $("#cookie_list").find(name);
    // if(obj.length==0)
    // {
    //     $("#cookie_list").append(add_obj);
    // }
    // $("#"+name).html(value);
    window.global_cookie[name] = value;
    //Cookies.set(name, value, { path: '' });
}

function getCookie(name)
{
    // var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");
    // if(arr=document.cookie.match(reg))
    //     return unescape(arr[2]);
    // else
    //     return null;

    // var obj= $("#cookie_list").find(name);
    // console.log("in getCookie:" + name)
    // if(obj.length == 0){
    //     console.log("null")
    //     return null;
    // }
    // else{
    //     console.log(obj.html())
    //     return obj.html();
    // }
    //return Cookies.get(name, { path: '' });
    return window.global_cookie[name];
}

function delCookie(name)
{
    // var exp = new Date();
    // exp.setTime(exp.getTime() + (-1 * 24 * 60 * 60 * 1000));
    // var cval=getCookie(name);
    // if(cval!=null)
    // document.cookie= name + "="+cval+";expires="+exp.toGMTString();

    //$("#cookie_list").find(name).remove();
    //Cookies.remove(name);
    //Cookies.set(name, "", { path: '' });
    window.global_cookie[name] = "";
}

function show_bot_dlg(obj)
{
    console.log($("#bot_chat_show").attr("style"));
    if($("#bot_chat_show").attr("style") == "display: none")
    {
        $("#bot_chat_show").attr("style","display");
        $("#bot_msg").focus();
        $("#bot_msg").select();
    }
    else
    {
        $("#bot_chat_show").attr("style","display: none");
    }
}

function make_send(msg, json_timestamp)
{
    var btn="";
    if(json_timestamp != "none")
    {
        console.log("json_timestamp", json_timestamp);
        btn = '&nbsp;&nbsp;<button class="btn btn-default btn-xs" onclick="show_json_info(';
        btn += "'"+json_timestamp + "'";
        btn += ')">查看json</button>';
    }
    var base_header='<div class="row msg_container base_sent">\
    <div class="col-md-10 col-xs-10">\
        <div class="messages msg_sent">\
            <p class="">';

    var base_middle = '</p>';
    var base_time = '<time datetime="" class="">' ;
    var base_footer =  btn + '</time>\
        </div>\
    </div>\
    <div class="col-md-2 col-xs-2 avatar">\
        <img src="static/img/user.gif" height="100" width="100" class="img-responsive">\
    </div>\
</div>';
    var date = new Date();
    var currentTime = date.Format("yyyy-MM-dd hh:mm:ss");
    var sent_msg = base_header + msg +base_middle + base_time + currentTime + base_footer;
    return sent_msg;
}

function make_receive(msg, json_timestamp)
{
    var btn="";
    if(json_timestamp != "none")
    {
        console.log("json_timestamp", json_timestamp);
        btn = '&nbsp;&nbsp;<button class="btn btn-default btn-xs" style="float:right" onclick="show_json_info(';
        btn += "'"+json_timestamp + "'";
        btn += ')">查看json</button>';
    }
    var base_header = '<div class="row msg_container base_receive">\
                        <div class="col-md-2 col-xs-2 avatar">\
                            <img src="static/img/unit_bot.png" height="100" width="100" class="img-responsive">\
                        </div>\
                        <div class="col-md-10 col-xs-10">\
                            <div class="messages msg_receive">\
                                <p class="">';
    var base_middle = '</p>\
                                <time datetime="" class="">';
    var base_footer = '</time>' + btn +
                            '</div>\
                        </div>\
                    </div>';
    var date = new Date();
    var currentTime = date.Format("yyyy-MM-dd hh:mm:ss");
    var rec_msg = base_header + msg + base_middle + currentTime + base_footer;
    return rec_msg;
}

function make_dlg(info)
{
    var content = $('#bot_msg_content');
    content.append(info);
    //以下为自动跳到最底部的操作
    var container = content;
    scrollTo = $('#msg_end');
    container.scrollTop(
        scrollTo.offset().top - container.offset().top + container.scrollTop()
    );
    container.animate({
        scrollTop: scrollTo.offset().top - container.offset().top + container.scrollTop()
    });
}

function deal_client_session()
{
    client_session = getCookie("client_session");
    console.log("in deal_client_session")
    console.log(client_session)
    if(client_session != null && client_session != "")
    {
        client_session = JSON.parse(client_session);
    }
    // console.log("first client_session");
    // console.log(client_session);
    if(client_session == null && client_session == "")
    {
       client_session = {"action_sequence":[], "cur_query_offset": -1, "client_results":"",  "candidate_options":[]};
    }
    else if(client_session['action_sequence'] == null)
    {
        client_session['action_sequence'] = [];
    }
    console.log("in deal_client_session deal")
    console.log(client_session);
    var action_list = getCookie("action_list");
    var as_obj = {};
    console.log("in deal_client_session get action_list")
    console.log(action_list);
    if(action_list == null)
        as_obj = {};
    else
    {
        var al = JSON.parse(action_list);
        if(JSON.stringify(al) != "{}")
        {
            as_obj["action_id"] = al["action_id"];
            as_obj["exe"] = al["main_exe"];
            as_obj["say"] = al["say"];
            as_obj["action_type"] = al["action_type"];
            as_obj["return_code"] = "";//action_list[""];
            // "action_id": "aaa",
            //                 "main_exe": "xxx",
            //                 "arg_list":["string", "string", "string"],                       //只当action是做意图或槽位澄清的时候，这里才会赋值；"string"通常是意图or槽位的名称
            //                 "exe_status":["success", "code1", "code2",..., "code5"],
            //                 "say": "xxx",
            //                 "action_type":
            //                 {
            //                         "act_type":"clarify"/"satisfy",
            //                         "act_target":"slot"/"intent",
            //                         "act_target_detail":"loc"/"loc,time",                             //允许同时传多个槽位
            //                         "act_type_detail":"select"/"ask"/"selectandask"
            //                 }

            // "action_id": "aaa",
            //                           "exe": "xxx",
            //                           "say": "xxx",
            //                           "action_type":
            //                           {
            //                                   "act_type":"clarify"/"satisfy",
            //                                   "act_target":"slot"/"intent",
            //                                   "act_target_detail":"loc"/"loc,time",                                    //允许同时传多个槽位
            //                                   "act_type_detail":"select"/"ask"/"selectandask"
            //                           }
            //                           "return_code": "code1",                      // action的返回值
        }

    }
    console.log("action_list is");
    console.log(as_obj);
    // console.log(client_session["action_sequence"] == null);
    // console.log((typeof(client_session["action_sequence"])  == "undefined"));

    // var tmp = [];
    if(JSON.stringify(as_obj) != "{}")
    {
        client_session["action_sequence"].push(as_obj);
        // if(client_session["action_sequence"] == null || (typeof(client_session["action_sequence"])  == "undefined"))
        // {
        //     //client_session["action_sequence"]
        //     // tmp.push(as_obj);
        //     //client_session["action_sequence"] = tmp;

        //     //console.log(tmp);
        //     console.log("here");
        //     let client_session = {"action_sequence":[]};
        //     client_session["action_sequence"].push({"a":1});
        //     console.log("client_session['action_sequence']");
        //     console.log(client_session["action_sequence"]);
        // }
    }
    //extend(client_session["action_sequence"], tmp);
    //client_session["action_sequence"] = tmp.concat();
    // for(var obj in tmp) {      
    //     client_session["action_sequence"][client_session["action_sequence"].length] = Extend(null,obj);
    // } 
    // for(var i =0 ;i<tmp.length; i++)
    // {
    //     client_session["action_sequence"].push(tmp[i]);
    // }
    //extend(test1,test);

    // client_session["cur_query_offset"] = -1;
    // client_session["client_results"] = "";
    // client_session["candidate_options"] = new Array();
    console.log("check client_session");
    console.log(client_session);

    client_session_str = JSON.stringify(client_session);
    //delCookie("client_session");
    setCookie("client_session", client_session_str);
    console.log("client_session is:");
    console.log(client_session_str);
    return client_session_str;
}

function clear_bot_session(content_id)
{
    var content = $('#'+content_id).html("");
    // delCookie("bot_session");
    // delCookie("action_list");
    // delCookie("client_session");
    setCookie("bot_session","");
    setCookie("action_list","{}");
    setCookie("client_session",'{"action_sequence":[],"cur_query_offset":-1,"client_results":"","candidate_options":[]}');
    //setCookie("client_session", null);
    $("#json_list").html("");
    $("#bot_json_content").html("");
    console.log("清空session");
    var timestamp = $("#timestamp_id").val( Date.parse(new Date()) );
    $.ajax({
        url:"/xiaopiaoWeb/Servlet/ClearSession",
        type:'get',
        data:{
            "userid":$("#userid").val()
        },
        success:function (msg) {
         console.log(msg["errno"]);
         console.log(msg["msg"]);
        }


    });

}

function hidden_json()
{
    $('#json_show').attr('style','display:none');
}

function make_json_content(json_timestamp, json_info)
{
    var html_content = "<div id="+json_timestamp+">" + syntaxHighlight(json_info) + "</div>";
    $("#json_list").append(html_content);
}

function show_json_info(json_timestamp)
{
    console.log("show_json_info");
    console.log(json_timestamp);
    $("#bot_json_content").html($("#"+json_timestamp).html());
    $("#json_show").attr("style", "display");
}

function send_to_bot(msg_id, content_id)
{
    var bot_fail_say = "我不知道应该怎么答复你";
    var hr_line = '<br><hr style="margin-bottom: -8px;margin-top: 9px;border-top: 2px solid #bfb7b7;"><br>' ;
    var msg = $('#'+msg_id).val();
    msg = msg.replace(/(\r\n|\n|\r)/gm, '');
    if(msg=="")return;
    $('#'+msg_id).val("");
    var content = $('#'+content_id);

    var bot_session = getCookie("bot_session");
    console.log("in send_to_bot: send bot session:");
    console.log(bot_session);
    if (bot_session == null)
    {
        bot_session = "";
    }

    var client_session = deal_client_session();
    var url = '/xiaopiaoWeb/Servlet/GetQuery';
    //var url = '/appservice/botverifytest?appid=' + 728;
    var username = $("#user_name_id").val();
    var timestamp = $("#timestamp_id").val();
    if (timestamp == "")timestamp = Date.parse(new Date());
    var bot_user_id = username + "_" + timestamp + "_" + RandomNumBoth();
    var log_id = username+"_log_" + Date.parse(new Date()) + "_" + RandomNumBoth();
    var send_json_timestamp = "json_" + Date.parse(new Date()) + "_" + RandomNumBoth();
    var send_json = {
        "appname":"xiaopiao",
        "sample_name":"ibf_qucloud_server",              //具体bot APP 的app_id
        "user_id":$("#userid").val(),                     // 用户ID
        "query":msg,
        //"user_info":{}, //用户当前的个性化信息
        "version":"1.0",                           //string 预留字段
    }
    console.log("send json:");
    console.log(send_json);
    make_json_content(send_json_timestamp, send_json);
    var sent_msg = make_send(msg, send_json_timestamp);
    make_dlg(sent_msg);

    $.ajax({
            url: url,
            type: 'post',//提交的方式
            dataType:'json',
            data: {
                "userid": $("#userid").val(),
                "query": msg,
            },
            success: function(msg) {
                //这是成功返回的数据，写自己的逻辑
                var recive_json_timestamp = "json_" + Date.parse(new Date()) + "_" + RandomNumBoth();
                if(msg["errno"]==0)
                {
                    console.log(msg["msg"]);

                    make_json_content(recive_json_timestamp, msg);
                    make_dlg(make_receive(msg["result"]["response"],recive_json_timestamp));

                }
                else
                {
                    make_dlg(make_receive(msg["msg"],"none"));
                    console.log(msg["errno"]);
                    console.log(msg["msg"]);
                }
                make_json_content(recive_json_timestamp, msg);

            },
            error: function(msg)
            {
                make_dlg(make_receive("请求服务失败"),"none");
            }
        });
    //make_dlg(make_receive(msg),"none");
}
  // function beforeCheck(treeId, treeNode) {


  //       var zTree = $.fn.zTree.getZTreeObj('choose_ztree');
  //       zTree.checkAllNodes(false);

  //          return true;
  //       }
  //       function onCheck(e, treeId, treeNode) {
  //       //     var zTree = $.fn.zTree.getZTreeObj('choose_ztree');
  //       // zTree.checkAllNodes(false);
  //           return true;

  //       }


$(document).ready(function() {
    $("#myModalCheckAppDiv").bind("keydown",function(e){
            // 兼容FF和IE和Opera
            var theEvent = e || window.event;
            var code = theEvent.keyCode || theEvent.which || theEvent.charCode;

            if (code == 13) {
                //回车执行查询
                    $("#check_result_btn").click();
                    var appservice_id = $("#appservice_id").val();
                    $("#send_query_" + appservice_id).focus();
                    $("#send_query_" + appservice_id).select();
                }
        });

    $("#bot_msg").bind("keydown",function(e){
            // 兼容FF和IE和Opera
            var theEvent = e || window.event;
            var code = theEvent.keyCode || theEvent.which || theEvent.charCode;

            if (code == 13) {
                //回车执行查询
                    $("#btn-chat-sent").click();
                    $("#bot_msg").focus();
                    //$("#bot_msg").select();
                    e.returnValue = false;
                    return false;
                }
        });

    clear_bot_session('bot_msg_content');

    var app_obj = angular.module("ngapp-appservice-model", []);
      app_obj.filter('to_trusted', ['$sce', function ($sce) {
        return function (text) {
            return $sce.trustAsHtml(text);
        };
    }]);
    app_obj.filter('get_acc', ['$sce', function ($sce) {
            return function (text) {
                return JSON.parse(text)['intent_acc']
            };
    }]);
       // app_obj.filter('to_trusted', ['$sce', function ($sce) {
       //  return function (text) {
       //      return $sce.trustAsHtml(text);
       //  };
    // }]);
    app_obj.directive('focusOn', function() {
       return function(scope, elem, attr) {
          scope.$on(attr.focusOn, function(e) {
              elem[0].focus();
          });
       };
    });
    app_obj.controller("ngAppserviceApp", function($scope, $rootScope, $http, $interval) {
        //$('#myTab li:eq(0) a').tab('show');
        $scope.appid=728;
        var date = new Date();
        var year = date.getFullYear();
        var month = date.getMonth()+1;
        var day = date.getDate();
        var hour = date.getHours();
        var minute = date.getMinutes();
        var second = date.getSeconds();
        $scope.time = year+'年'+month+'月'+day+'日'
        //$scope.online_service = [];
        // $scope.cur_evail_setting = {
        //     cur_page:1,
        //     total_page:1,
        //     total_num:1
        // }
        $scope.cur_evail_detail_setting = {
            cur_page:1,
            total_page:1,
            total_num:1
        }
        $scope.table_dict = {};
        $scope.eval_back = function(eval_id, package_id,cancel_id){
        var $table =   $scope.table_dict[eval_id];
              // = table.table().node();
    // console.log(table.rows());
        var id_list =  new Array();
        var rows = $scope.table_dict[eval_id].rows().nodes();
        for (var i = 0; i < rows.length; i++){
            if(jQuery(rows[i]).find('input').is( ":checked" )){
                id_list.push(jQuery(rows[i]).find('input')[0].id);
            }
        }
        // console.log(jQuery($scope.table_dict[eval_id].rows().nodes()[0]).find('input').is( ":checked" ));

        //  var $chkbox_checked    = $('#query_table_' + eval_id + ' tbody input[type="checkbox"]:checked');
        //  for (var i = 0; i < $chkbox_checked.length; i++){
        //   id_list.push($chkbox_checked [i].id);
        //  }
         console.log(id_list)
         if (id_list.length==0){
            alert("选中为空");
            return;
         }
            $.ajax({
                    url: "/labeldata/evalback?type=eval_query&appid=" + $scope.appid + "&package_id=" + package_id,
                    type: 'post',//提交的方式
                    dataType:'json',
                    data: {"id_list":id_list,"package_id":package_id,"type":"eval_query","appid":$scope.appid},
                    success: function(msg) {
                        //这是成功返回的数据，写自己的逻辑
                        if(msg["errno"]==0)
                        {
                            alert("请回标注页面重新标注")
                            document.getElementById(cancel_id).click();
                        }
                        else
                        {
                            alert(msg["msg"]);
                        }
                    },
                    error: function(msg)
                    {
                        alert("提交任务失败，请重试");
                    }
                });


            // $http.get("/labeldata/evalback?type=eval_query&appid=" + $scope.appid + "&package_id=" + package_id).success(function(response){
            //     if(response.errno == 0){
            //         document.getElementById(cancel_id).click();
            //     }
            //     else{
            //         alert(response.msg);
            //     }

            // })
        }


        $scope.get_eval_list = function(page){
            var url = "/labeldata/evallist?page=" + page + "&appid=" + $scope.appid;
            $http.get(url)
            .success(function(response) {
                //response = JSON.parse(response);
                if(response.errno != 0){
                    alert(response.msg);
                    return;
                }

               for(var i = 0; i < response.data.length; i++){

                    result =response.data[i].eval_result;
                    // console.log(result)
                    if (result == undefined || result==''){
                         response.data[i].intent_acc = -1;
                         response.data[i].slots_acc_absolute = -1;
                         response.data[i].acc = -1;
                         response.data[i].slots_acc = -1;
                         response.data[i].slots_recall = -1;

                    }

                    else{
                        var result = JSON.parse(response.data[i].eval_result);
                        response.data[i].intent_acc = result.intent_acc;
                        response.data[i].slots_acc_absolute = result.slots_acc_absolute;
                        response.data[i].acc = result.acc;
                        response.data[i].slots_acc = result.slots_acc;
                        response.data[i].slots_recall = result.slots_recall;
                    }


               }
               $scope.evallist = response.data;
               console.log($scope.evallist);

               // $scope.cur_evail_setting.cur_page = response.data.page;
               // $scope.cur_evail_setting.total_page = response.data.total;
               // $scope.cur_evail_setting.total_num = response.data.total_num;
               // console.log($scope.cur_evail_setting)
            })
               // $.ajax({
               //          url: "/labeldata/evallist?page=" + page + "&appid=" + $scope.appid,
               //          type:'GET',//提交的方式
               //          async: false,
               //          success: function(response) {

               //      });
               // $scope.evallist_detail = new Array();
               // for (var i = 0; i < $scope.evallist[i]; i++){
               //      $.ajax({
               //          url: "labeldata/evaldetail?type=query&appid=" + $scope.appid +"&package_id=" + $scope.evallist[i].package_list,
               //          type:'GET',//提交的方式
               //          async: false,
               //          success: function(response) {
               //              if(response.errno != 0){
               //                  alert(response.msg);
               //                  return;
               //              }
               //             evallist_detail[response.data.id] = response.data;
               //          }
               //      });

               // }
            // $http.get("labeldata/evallist?appid=" + $scope.appid).success(function(response){})
            // $http.get("/labeldata/evallist?appid=" + $scope.appid)
            // .success(function(response) {
            //     if (response.errno == 0)
            //     {
            //         $scope.evallist = response.data;
            //     }

            // });

        }
        $scope.get_eval_list(1);
        var rows_selected = [];


       $("#eval_table").bind("keydown",function(e){
        // 兼容FF和IE和Opera
    var theEvent = e || window.event;
    var code = theEvent.keyCode || theEvent.which || theEvent.charCode;
    if (code == 13) {
        //回车执行查询
         if ($scope.focus.index == 0){
               $('#' +$scope.focus.id).trigger('click');
         }
        }
    });
    $scope.get_eval_detail = function(item){
                var editor;
        var table_id = '#query_table_' + item.id;
        var col_name = '实例';

    // editor = new $.fn.dataTable.Editor( {
    //     ajax: "/labeldata/auditedit?appid=" + $scope.appid + "&type=" + type,
    //     table: table_id,
    //     idSrc:  'id',
    //     fields: [
    //      {
    //           label: col_name + ":",
    //           name: 'query'
    //         },
    //         {
    //             label: "意图:",
    //             name: "intent"
    //         },
    //            {
    //             label: "槽位:",
    //             name: "slots"
    //         }
    //         // ,
    //         // {
    //         //   label:"slots:",
    //         //   name: "slots"
    //         // }

    //     ]
    // } );
    console.log(item)

    var table = $(table_id).DataTable( {
        destroy: true,
        // dom: "Bfrtip",
        ajax: "/labeldata/list?&appid=" + $scope.appid +"&is_pagination=false&type=eval_query&package_id=" + item.package_list,
        columns: [
         //      {data:null,
         // 'targets': 0,
         // 'searchable':false,
         // 'orderable':false,
         // 'width':'1%',
         // 'className': 'dt-body-center',
         // 'render': function (data, type, row){
         //      // console.log(data.id);
         //     return '<input id='+ data.id +  ' type="checkbox">';
         //      }
         //    },
            // {data:null, render:function( data, type, row ){
            //   return 0;
            // },editField: "label"},
            { data: 'query',"width": "30%" },
            { data: "intent" },
            { data: "intent_m" },
            {data : "intent_match"},
            {data:null , editField: "slots","width": "20%", render: function ( data, type, row ) {
                // Combine the first and last names into a single table field
                // console.log(data)
                  var result = "";

                  try
                    {
                       var slots = JSON.parse(data.slots);
                        // console.log(slots);
                          for (var i = 0; i < slots.length; i++){
                    result += slots[i].type + ":" + slots[i].word  + "<br>";
                  }
                      //在这里运行代码
                      }
                catch(err)
                 {
                      console.log(err)
                      //在这里处理错误
                  }
                  // console.log(result)

                  return result;

            }},


            {data:null , editField: "slots_m","width": "20%", render: function ( data, type, row ) {
                // Combine the first and last names into a single table field
                // console.log(data)
                  var result = "";

                  try
                    {
                       var slots = JSON.parse(data.slots_m);
                        // console.log(slots);
                          for (var i = 0; i < slots.length; i++){
                    result += slots[i].type + ":" + slots[i].word  + "<br>";
                  }
                      //在这里运行代码
                      }
                catch(err)
                 {
                     // console.log('err in slots')
                      //在这里处理错误
                  }

                  return result;

            }},
            {data:null ,"width": "20%", render: function ( data, type, row ) {
                    var result = "";

                  try
                    {
                       var slots_match = JSON.parse(data.slots_match);
                        // console.log(slots);
                        // result += "准确率:" + slots_match.slots_acc + '%，召回率:' + slots_match.slots_recall + '%';
            // store_result['slots_num'] = ori_slot_num
            // store_result['slots_m_num'] = mode_slot_num
            // store_result['slots_match_num'] = slot_match_num
                    if (slots_match.slots_match_num == slots_match.slots_num){
                        if (slots_match.slots_num == 0){
                        result += 'null'
                        }
                        else{
                            result += 'yes'
                        }
                        // result +=

                      //在这里运行代码
                      }
                    else{
                        result +='no,' + slots_match.slots_match_num + '/' + slots_match.slots_num;

                    }
                }
                catch(err)
                 {
                     // console.log('err in slots')
                      //在这里处理错误
                  }

                  return result;
            }}

            // {data: "slots_match"},
            // { data: null, render: function ( data, type, row ) {
            //     // Combine the first and last names into a single table field
            //     if (data.intervene == 1 && data.status==1){
            //       return "已生效";
            //     }
            //     else{
            //       return "未生效";
            //     }
            //     // return data.first_name+' '+data.last_name;
            // } }


        ],
        keys: true,
        rowCallback: function(row, data, dataIndex){
         // Get row ID
         var rowId = data[0];

         // If row ID is in the list of selected row IDs
         if($.inArray(rowId, rows_selected) !== -1){
            $(row).find('input[type="checkbox"]').prop('checked', true);
            $(row).addClass('selected');
         }
      },
        // select: {
        //     style:    'os',
        //     selector: 'td:first-child',
        //     blurable: true
        // },
        buttons: [
            // { extend: "create", editor: editor },
            // { extend: "edit",   editor: editor },
            // { extend: "remove", editor: editor }
        ]
    } );
    $scope.table_dict[item.id] = table;
    table.on('draw', function(){
      // Update state of "Select all" control
      updateDataTableSelectAllCtrl(table);
   });

    $scope.focus ={
        index:-1,
        id:""
    }

   table.on('key-focus', function (e, datatable, cell) {

     console.log(cell.node());
     $scope.focus.index = cell.index()['column'];
     $scope.focus.id = jQuery(cell.node()).find('input').attr('id');
     console.log( $scope.focus);
    });



    // Disable KeyTable while the main editing form is open
   //  editor
   //      .on( 'open', function ( e, mode, action ) {
   //          if ( mode === 'main' ) {
   //              table.keys.disable();
   //          }
   //      } )
   //      .on( 'close', function () {
   //          table.keys.enable();
   //      } );


   //    table.on('draw', function(){
   //    // Update state of "Select all" control
   //    updateDataTableSelectAllCtrl(table);
   // });
    $('thead input[name="select_all"]', table.table().container()).on('click', function(e){
      if(this.checked){
        console.log
          console.log(item)
        $('table[id="query_table_' + item.id + '"] tbody input[type="checkbox"]:not(:checked)').trigger('click');
      } else {
         $('table[id="query_table_' + item.id + '"] tbody input[type="checkbox"]:checked').trigger('click');
      }

      // Prevent click event from propagating to parent
      e.stopPropagation();
        });

    }
            // $.ajax({
            //             url: "/labeldata/list?page=" + page + "&appid=" + $scope.appid +"&is_pagination=true&status=5&type=eval_query&package_id=" + item.package_list,
            //             type:'GET',//提交的方式
            //             async: false,
            //             success: function(response) {
            //                 response = JSON.parse(response);
            //                 if(response.errno != 0){
            //                     alert(response.msg);
            //                     return;
            //                 }
            //                $scope.evaldetail = response.data.list;
            //                $scope.cur_evail_detail_setting.cur_page = response.data.page;
            //                $scope.cur_evail_detail_setting.total_page = response.data.total;
            //                $scope.cur_evail_detail_setting.total_num = response.data.total_num;

            //                console.log(response.data.list)
            //             }
            //         });




        $scope.get_app_service_sandbox = function(product_line){
            $http.get("/appservice/list?appid=" + $scope.appid + "&product_line="+product_line)
            .success(function(response) {
                if (response.errno == 0)
                {
                    $scope.app_service = response.data.appservice;
                    $scope.appservice = $scope.app_service[0];
                    console.log($scope.app_service);
                    console.log($scope.appservice);
                }
            });
        }
        $scope.get_app_service= function(product_line){
            $http.get("/appservice/list?appid=" + $scope.appid + "&product_line="+product_line)
            .success(function(response) {
                if (response.errno == 0)
                {
                    $scope.online_service = response.data.appservice;
                }

            });
        }
        $scope.get_service_type = function(){
            $http.get("/appservice/servicetypelist?appid=" + $scope.appid)
            .success(function(response) {
                if (response.errno == 0)
                {
                    $scope.service_type = response.data.servicetype;
                }

            });
        }
        $scope.get_model_template = function(){
            $http.get("/appservice/modeltemplatelist?appid=" + $scope.appid)
            .success(function(response) {
                if (response.errno == 0)
                {
                    $scope.model_template = response.data.modeltemplate;
                    //alert($scope.model_template[0].model_template_name);
                }

            });
        }
        $scope.check_result = function(id, which){
                var url = '/appservice/verify?appid=' + $scope.appid;
                if (which == "qubot")
                {
                    url = '/appservice/verify?appid=' + $scope.appid;
                }
                //var appservice_id = $("#appservice_id").val();
                //angular.element("#send_query_" + appservice_id).focus();

                $.ajax({
                    url: url,
                    type: 'post',//提交的方式
                    dataType:'json',
                    data: {"query": $("#send_query_"+id).val(), "id":$("#service_id_"+id).val(), "type": which, },
                    success: function(msg) {
                        //这是成功返回的数据，写自己的逻辑
                        console.log(msg["errno"] + " " + which);
                        if(msg["errno"]==0)
                        {
                            if (which == "qubot")
                            {
                                $("#qu_result_div_"+id).attr("style", "display:none");
                                $("#bot_result_div_"+id).attr("style", "display");
                                $('#qu_result_'+id).attr("style", "display:none");
                                $('#bot_result_'+id).attr("style", "display");
                                $('#bot_result_'+id).html(syntaxHighlight(msg["data"]));
                            }
                            else{
                                $("#qu_result_div_"+id).attr("style", "display");
                                $("#bot_result_div_"+id).attr("style", "display:none");
                                $('#qu_result_'+id).attr("style", "display");
                                $('#bot_result_'+id).attr("style", "display:none");
                                $('#qu_result_'+id).html(syntaxHighlight(msg["data"]));
                            }
                        }
                        else
                        {
                            if(which == "qu")
                            {
                                $("#qu_result_div_"+id).attr("style", "display");
                                $("#bot_result_div_"+id).attr("style", "display:none");
                            }
                            else if(which == "qubot")
                            {
                                $("#qu_result_div_"+id).attr("style", "display:none");
                                $("#bot_result_div_"+id).attr("style", "display");
                            }
                            var html = 'service unvailable, please try again late';
                            $("#qu_result_"+id).html(html);
                            $("#bot_result_"+id).html(html);
                        }
                        var appservice_id = $("#appservice_id").val();
                        $("#send_query_" + appservice_id).focus();
                        $("#send_query_" + appservice_id).select();
                    },
                    error: function(msg)
                    {
                        var html = 'server crash'
                        $("#qu_result_"+id).html(html);
                        $("#bot_result_"+id).html(html);
                    }
                });
                return false;
        };

        $scope.appTypeChange = function(appid){
                var obj = document.getElementById("app_type_"+appid);
                var app_type = obj.options[obj.selectedIndex].value;
                bot_name = document.getElementById("bot-name-form-group_"+appid);
                bot_model = document.getElementById("bot-model-form-group_"+appid);
                if (app_type == "qu")
                {
                        bot_name.style.display="none";
                        bot_model.style.display="none";
                }
                if (app_type == "qubot")
                {
                        bot_name.style.display="";
                        bot_model.style.display="";
                }

            }
               $scope.set_package_list_info = function(children){
                //添加包展现的附加信息
                for(var i = 0; i< children.length; i++)
                {
                    children[i].name += " ( " + children[i].labeled_count + " / " + children[i].current_volume + " )";
                }
            }

           $scope.init_move_tree = function(){
    var setting = {
      check: {
                enable: true,
                chkStyle: "radio",
                radioType: "all"
            },
      data: {
        key: {

        },
        simpleData: {
          enable: true
        }
      },


      // view: {
      //   // addHoverDom: addHoverDom,
      //   // removeHoverDom: removeHoverDom,
      //   selectedMulti: false
      // },
      // edit: {
      //   enable: true,
      // },

      callback: {
                // beforeCheck: beforeCheck,
                // onCheck: onCheck
      }

    };

    var zNodes =[
      { name:"可用于评估的包", id : "query_parent", open:true,children: [],isParent:true,nocheck:true}
      // ,{ name:"模板", id : "pattern_parent",open:true, children: [],isParent:true,nocheck:true},
      ];
                  $.ajax({
                        url: "/package/list?appid=" + $scope.appid +"&type=query&eval=true",
                        type:'GET',//提交的方式
                        async: false,
                        success: function(response) {
                           response = JSON.parse(response);
                          zNodes[0].children = response;
                          $scope.set_package_list_info(zNodes[0].children);
                        }
                    });
                  // $.ajax({
                  //       url: "/package/list?appid=" + $scope.appid +"&type=pattern&eval=true",
                  //       type:'GET',//提交的方式
                  //       async: false,
                  //       success: function(response) {
                  //          response = JSON.parse(response);
                  //         zNodes[1].children = response;
                  //       }
                  //   });

    $.fn.zTree.init($("#choose_ztree"), setting, zNodes);
    }

     $scope.eval_package = function(description_id, cancel_id){

       var zTree = $.fn.zTree.getZTreeObj('choose_ztree');
       selected_package = zTree.getCheckedNodes(true);
       // console.log(selected_package);
       var new_package_id = new Array();
       // console.log(selected_package);
        // var id_list =  new Array();
        // console.log(selected_package[i].id );
        for (var i = 0; i < selected_package.length; i++){
          if (selected_package[i].id !="query_parent" && selected_package[i].id != "pattern_parent"){
            new_package_id.push(selected_package[i].id);

            // console.log(selected_package[i].id );
            break;
          }
        }
             if (new_package_id.length==0){
                alert('选中为空！')
                return;
            }
              $.ajax({
                        url: '/labeldata/evalstart?appid=' + $scope.appid,
                        type: 'post',//提交的方式
                        dataType:'json',
                        data: {"description":$('#' + description_id).val(),"package_list":new_package_id},
                        success: function(msg) {
                            // alert(msg.errno)
                            //这是成功返回的数据，写自己的逻辑
                            if(msg.errno==0)
                            {
                                $scope.get_eval_list(1);
                                document.getElementById(cancel_id).click();
                                // var t=setTimeout("$scope.get_eval_list(1);document.getElementById(cancel_id).click();",2000);
                                //alert("success");


                                // $scope.get_eval_list(1);
                                 // $scope.schema_init();
                            }
                            else
                            {
                                alert(msg["msg"]);
                            }
                        },
                        error: function(msg)
                        {
                            alert("修改失败，请重试");
                        }
                    });


                  // $interval(function(){

                  //                       }, 2000,1);
        }



            // $.ajax({
            //             url: '/labeldata/evalstart?appid=' + $scope.appid + "&description=" + $('#' + description_id).val() + "&package_list=" + new_package_id,
            //             type: 'get',//提交的方式
            //             success: function(msg) {
            //               msg = JSON.parse(msg);
            //               if(msg.errno == '0'){
            //                 //这是成功返回的数据，写自己的逻辑
            //                   // alert('打回成功')
            //                   // document.getElementById(form_id).reset();
            //                   document.getElementById(cancel_id).click();
            //                 }
            //                 else
            //                 {
            //                     alert(msg['msg']);
            //                 }
            //             },
            //             error: function(msg)
            //             {
            //                 alert("服务器内部错误");
            //             }
            //         });


  // }

        $scope.open_modal = function(id){
            //alert(id);
            //$('#'+id)
            //$scope.$broadcast('focusonquery');
            //$('#'+id).find("input").trigger("click");
            var appservice_id = $("#appservice_id").val();

            // angular.element("#send_query_" + appservice_id).focus();

            //$("#send_query_" + appservice_id).focus();
            //$("#send_query_" + appservice_id).select();
            $scope.init_app();
            $interval(function(){
                   $("#send_query_" + appservice_id).focus();
                   $("#send_query_" + appservice_id).select();
                 }, 500, 1);
            }
        $scope.show_info = function(info){
            alert(info);
        };
        $scope.reset_form = function(id, item_id)
        {
            var obj = $("#qu_result_div_"+item_id);
            obj.attr("style", "display:none");
            document.getElementById(id).reset();
        }
        $scope.app_update = function(id){
            data = {
                "id" : id,
                "app_type": $("#app_type_" + id).val(),
                "qu_name": $("#qu_name_" + id).val(),
                "qu_model": $("#qu_model_" + id).val(),
                "bot_name": $("#bot_name_" + id).val(),
                "bot_model": $("#bot_model_" + id).val(),
                "app_id":$scope.appid,
            }
            $.ajax({
                    url: '/appservice/update?appid=' + $scope.appid,
                    type: 'post',//提交的方式
                    dataType:'json',
                    data: data,
                    success: function(msg) {
                        //这是成功返回的数据，写自己的逻辑
                        if(msg["errno"]==0)
                        {
                                document.getElementById("app_update_cancel_" + id).click();
                                alert("修改成功");
                        }
                        else
                        {
                            alert(msg["msg"]);
                        }
                    },
                    error: function(msg)
                    {
                        alert("修改失败，请重试");
                    }
                });
        }
        $scope.onekey_online = function(id)
        {
            var rooms = document.getElementsByName("rooms");
            var room = "";
            for (var i=0;i<rooms.length; i++)
            {
                if( jQuery(rooms[i]).prop("checked") )
                {
                    room +=  jQuery(rooms[i]).val() + ";"
                }
            }
            data = {
                "id":id,
                "rooms": room,
                "qu_name":$("#onekey_qu_name_"+id).val(),
                "qu_model_template":$("#onekey_qu_model_"+id).val(),
                "bot_name":$("#onekey_bot_name_"+id).val(),
                "bot_model_template":$("#onekey_app_type_"+id).val(),
                "type":$("#onekey_app_type_"+id).val(),
            }
            $.ajax({
                    url: '/appservice/upgrade?appid=' + $scope.appid,
                    type: 'post',//提交的方式
                    dataType:'json',
                    data: data,
                    success: function(msg) {
                        //这是成功返回的数据，写自己的逻辑
                        if(msg["errno"]==0)
                        {
                                $scope.init_app();
                                alert("提交上线任务成功");
                        }
                        else
                        {
                            alert(msg["msg"]);
                        }
                    },
                    error: function(msg)
                    {
                        alert("提交任务失败，请重试");
                    }
                });
        }

        $scope.set_model_to_sandbox = function (id, stype, service_name, service_type, model_path, version, model_template){
            var chkbtn = $("#check_sandbox_effect_" + id);
            chkbtn.attr('disabled',"true");
            chkbtn.html("<img src='static/img/loading9.gif' style='width:18px'></img>提交中,请稍后......");
            $.ajax({
                    url: '/appservice/updatemodel?appid=' + $scope.appid,
                    type: 'post',//提交的方式
                    dataType:'json',
                    timeout : 0,
                    data: {"id": id,
                    "service_name":service_name,
                    "service_type": service_type,
                    "model_type": model_path,
                    "service_version":version,
                    "stype": stype,
                    "model_template": model_template},
                    success: function(msg) {
                        //这是成功返回的数据，写自己的逻辑
                        if(msg["errno"]==0)
                        {
                                $scope.init_app();
                                $("#set_model_to_sandbox_cancel_" + id).trigger("click");
                                alert("提交模型上沙盒任务成功");
                                auto_refresh();
                        }
                        else
                        {
                            alert(msg["msg"]);
                            auto_refresh();
                        }
                    },
                    error: function(msg)
                    {
                        alert("sofacloud处理超时，请重试");
                        auto_refresh();
                    }
                    // error: function(XMLHttpRequest, textStatus, errorThrown) {
                    //      console.log(XMLHttpRequest.status);
                    //      console.log(XMLHttpRequest.readyState);
                    //      console.log(textStatus);
                    //      console.log(errorThrown);
                    //  }
                });
        }


    //});
    //app_obj.controller("ngAppserviceModel", function($scope, $rootScope, $http) {
        // $scope.appid=728;
        // $('#myTab li:eq(1) a').tab('show');
        $scope.model = {
            model_list : []
        }
        $scope.show_info = function(info){
            alert(info);
        };
        $scope.goto_page = function(page){
            $http.get("/appservice/modellist?appid=" + $scope.appid + "&page=" + page)
            .success(function(response) {
                $scope.model.model_list = response.data.model_list;
                $scope.model.pageall = response.data.total_num;
                $scope.model.total = response.data.total;
                $scope.model.per_num = response.data.per_num;
                $scope.model.this_page = response.data.page;
                $scope.model.pre_page = response.data.prev;
                $scope.model.next_page = response.data.next;
            });
        }
        $scope.get_newest_qubot = function(){
            $http.get("/appservice/quickupdatedata?appid=" + $scope.appid)
            .success(function(response) {
                $scope.newest_qubot = response.data;
            });
        }

        $scope.onekey_effect = function(){
            var chkbtn = $("#check_sandbox_effect_newest");
            chkbtn.attr('disabled',"true");
            chkbtn.html("<img src='static/img/loading9.gif' style='width:18px'></img>提交中,请稍后......");
            var qu = $scope.newest_qubot.qu;
            var bot = $scope.newest_qubot.bot;
            $.ajax({
                    url: '/appservice/quickupdate?appid=' + $scope.appid,
                    type: 'post',//提交的方式
                    dataType:'json',
                    timeout : 0,
                    data: {
                    "qu_model_type": qu.model_path,
                    "qu_service_version": qu.version,
                    "qu_id": qu.id,
                    "qu_service_name": qu.service_name,
                    "qu_model_template": qu.model_template,
                    "bot_model_type": bot.model_path,
                    "bot_service_version": bot.version,
                    "bot_id": bot.id,
                    "bot_service_name": bot.service_name,
                    "bot_model_template": bot.model_template,
                    "qu_stype": $scope.newest_qubot.qu.stype,
                    "bot_stype": $scope.newest_qubot.bot.stype,
                    },
                    success: function(msg) {
                        //这是成功返回的数据，写自己的逻辑
                        if(msg["errno"]==0)
                        {
                                $scope.init_app();
                                alert("提交最新qu(" + qu.version_name + ")和bot("+ bot.version_name +")模型上沙盒任务成功");
                                auto_refresh();
                        }
                        else
                        {
                            alert(msg["msg"]);
                            auto_refresh();
                        }
                    },
                    error: function(msg)
                    {
                        alert("sofacloud处理超时，请重试");
                        auto_refresh();
                    }
                });
        }
        $scope.init_app = function(){
            $scope.get_app_service_sandbox("sand_box");
            //$scope.get_app_service("online");
            $scope.get_newest_qubot();
            $scope.get_service_type();
            $scope.get_model_template();
            $scope.goto_page(1);

        }
        $scope.init_app();
        // $interval(function(){
        //     $scope.init_app();
        // }, 60000);


    });
});
var recorder;
var timeout ;
var isgetPER=false;

function voice_mousedown () {
            document.getElementById("voice_erro").innerHTML="";
    document.getElementById('voice_btn_img').src="./static/img/microphone.gif";
    if(!isgetPER || !recorder)
    {
        HZRecorder.get(function (rec) {
                recorder = rec;
                recorder.start();});
        isgetPER=true;
    }
    else
    {
        recorder.start();
    }
    timeout = setTimeout(function() {
            document.getElementById('voice_btn_img').src="./static/img/voice.static.png";
            //stopandupload();
            }, 10000);
}

function voice_mouseup() {
    clearTimeout(timeout);
    document.getElementById('voice_btn_img').src="./static/img/voice.static.png";
    stopandupload();
}

function stopandupload()
{
    if(recorder){
            recorder.stop();
            recorder.upload("/voice", function (state, msg) {
            console.log(msg);
            //msg=JSON.parse(JSON.stringify(e));
            if (state=="ok") {
                if (msg["errno"]==0)
                {
                    document.getElementById("bot_msg").value=msg["result"];
                    send_to_bot('bot_msg', 'bot_msg_content');
                }
                else if(msg["errno"]==3301)
                {
                    document.getElementById("voice_erro").innerHTML="语音识别错误";
                }
                console.log(msg["errno"]+":"+msg["err_msg"]);

            }
            else {
                //document.getElementById("voice_erro").innerHTML="语音识别错误";
                //console.log("上传音频错误");
                document.getElementById("voice_erro").innerHTML="上传音频错误";
            }
            });


    }
}
</script>
</div>
<!-- Bootstrap core JavaScript
    ================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="./static/js/bootstrap.min.js"></script>
<script src="./static/js/angular.min.1.4.6.js"></script>
<script src="./static/js/angular-route.js"></script>
<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="./static/js/ie10-viewport-bug-workaround.js"></script>


<footer class="footer" style="z-index:1000">
    <div class="container" style="text-align:center;">
        <p class="pull-center">xiaopiao 2017

        </p>
    </div>
</footer>


<!--06032007470740580874032719-->
<script> var _trace_page_logid = 0603200747; </script></div></div><div id="haloword-lookup" class="ui-widget-content ui-draggable"><div id="haloword-title"><span id="haloword-word"></span><a herf="#" id="haloword-pron" class="haloword-button" title="发音"></a><audio id="haloword-audio"></audio><div id="haloword-control-container"><a herf="#" id="haloword-add" class="haloword-button" title="加入单词表"></a><a herf="#" id="haloword-remove" class="haloword-button" title="移出单词表"></a><a href="http://unit.baidu.com/appservice/index?appid=728#" id="haloword-open" class="haloword-button" title="查看单词详细释义" target="_blank"></a><a herf="#" id="haloword-close" class="haloword-button" title="关闭查询窗"></a></div><br style="clear: both;"></div><div id="haloword-content"></div></div></body></html>